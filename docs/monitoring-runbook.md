# ChitLaq M1 MVP - Monitoring Runbook

> **Generated by PROMPT 1.4** - Monitoring & Observability Stack  
> **Senior SRE** - 15+ years monitoring and incident response experience

## Table of Contents
- [Overview](#overview)
- [Monitoring Stack](#monitoring-stack)
- [Alerting Procedures](#alerting-procedures)
- [Incident Response](#incident-response)
- [Dashboard Usage](#dashboard-usage)
- [Troubleshooting Guide](#troubleshooting-guide)
- [Maintenance Procedures](#maintenance-procedures)

## Overview

This runbook provides comprehensive guidance for monitoring, alerting, and incident response for the ChitLaq M1 MVP platform. It covers the complete observability stack including Prometheus, Grafana, Alertmanager, Loki, and OpenTelemetry.

### Key Monitoring Principles
- **Proactive Monitoring**: Detect issues before they impact users
- **Comprehensive Coverage**: Monitor infrastructure, applications, and business metrics
- **Clear Escalation**: Well-defined alerting and response procedures
- **Continuous Improvement**: Regular review and optimization of monitoring

## Monitoring Stack

### Core Components

#### Prometheus
- **Purpose**: Metrics collection and storage
- **Port**: 9090
- **URL**: https://monitoring.chitlaq.com
- **Retention**: 30 days
- **Scrape Interval**: 15 seconds

#### Grafana
- **Purpose**: Visualization and dashboards
- **Port**: 3000
- **URL**: https://monitoring.chitlaq.com/grafana
- **Default Login**: admin/chitlaq2024!

#### Alertmanager
- **Purpose**: Alert routing and notification
- **Port**: 9093
- **URL**: https://monitoring.chitlaq.com/alertmanager

#### Loki
- **Purpose**: Log aggregation
- **Port**: 3100
- **URL**: https://monitoring.chitlaq.com/loki

#### OpenTelemetry
- **Purpose**: Distributed tracing
- **Jaeger UI**: https://monitoring.chitlaq.com/jaeger

### Service Endpoints

| Service | Health Check | Metrics Endpoint |
|---------|-------------|------------------|
| API Gateway | `/health` | `/metrics` |
| Web App | `/api/health` | `/api/metrics` |
| Realtime Service | `/health` | `/metrics` |
| Feed Service | `/health` | `/metrics` |
| Search Service | `/health` | `/metrics` |
| Admin Panel | `/api/health` | `/api/metrics` |
| PostgreSQL | `SELECT 1` | Port 9187 |
| Redis | `PING` | Port 9121 |
| Nginx | `/nginx_status` | Port 9113 |

## Alerting Procedures

### Alert Severity Levels

#### Critical (P0)
- **Response Time**: Immediate (< 5 minutes)
- **Escalation**: Page on-call engineer
- **Examples**:
  - Database down
  - API completely unavailable
  - Security breach detected
  - Disk space > 95%

#### Warning (P1)
- **Response Time**: 15 minutes
- **Escalation**: Slack notification
- **Examples**:
  - High error rate (> 1%)
  - Slow response times (> 500ms)
  - Memory usage > 85%
  - Failed login attempts spike

#### Info (P2)
- **Response Time**: 1 hour
- **Escalation**: Email notification
- **Examples**:
  - Service restart
  - Configuration changes
  - Maintenance windows

### Alert Routing

```yaml
# Critical alerts go to:
- PagerDuty (immediate page)
- Slack #critical-alerts
- Email: critical@chitlaq.com

# Warning alerts go to:
- Slack #warnings
- Email: warnings@chitlaq.com

# Info alerts go to:
- Slack #alerts
- Email: alerts@chitlaq.com
```

### Alert Acknowledgment

1. **Acknowledge in Alertmanager**: Click "Acknowledge" button
2. **Update Slack**: Post in relevant channel with status
3. **Create Incident**: If P0/P1, create incident ticket
4. **Update Stakeholders**: Notify relevant teams

## Incident Response

### Incident Classification

#### Severity 1 (Critical)
- **Impact**: Service completely down
- **Users Affected**: > 50%
- **Response Time**: 5 minutes
- **Resolution Target**: 1 hour

#### Severity 2 (High)
- **Impact**: Significant degradation
- **Users Affected**: 10-50%
- **Response Time**: 15 minutes
- **Resolution Target**: 4 hours

#### Severity 3 (Medium)
- **Impact**: Minor issues
- **Users Affected**: < 10%
- **Response Time**: 1 hour
- **Resolution Target**: 24 hours

#### Severity 4 (Low)
- **Impact**: Cosmetic issues
- **Users Affected**: Minimal
- **Response Time**: 4 hours
- **Resolution Target**: 1 week

### Incident Response Process

#### 1. Detection and Assessment
```bash
# Check overall system health
./scripts/health-check.sh

# Check specific service
curl -f http://localhost:3001/health

# Check logs
docker logs chitlaq-api-gateway --tail 100
```

#### 2. Initial Response
- **Acknowledge alert** in Alertmanager
- **Assess impact** and classify severity
- **Notify stakeholders** via Slack
- **Create incident ticket** if S1/S2

#### 3. Investigation
- **Check dashboards** for patterns
- **Review logs** for error messages
- **Analyze metrics** for anomalies
- **Check recent changes** in deployment

#### 4. Resolution
- **Implement fix** or workaround
- **Verify resolution** with health checks
- **Update stakeholders** on status
- **Close incident ticket**

#### 5. Post-Incident
- **Conduct post-mortem** within 48 hours
- **Document lessons learned**
- **Update runbooks** if needed
- **Implement preventive measures**

### Emergency Contacts

| Role | Primary | Secondary | Escalation |
|------|---------|-----------|------------|
| On-Call Engineer | +1-XXX-XXX-XXXX | +1-XXX-XXX-XXXX | Engineering Manager |
| Database Admin | +1-XXX-XXX-XXXX | +1-XXX-XXX-XXXX | DBA Team Lead |
| Security Team | +1-XXX-XXX-XXXX | +1-XXX-XXX-XXXX | CISO |
| Infrastructure | +1-XXX-XXX-XXXX | +1-XXX-XXX-XXXX | SRE Manager |

## Dashboard Usage

### System Overview Dashboard
- **Purpose**: High-level system health
- **Key Metrics**:
  - Request rate and response times
  - Error rates
  - Resource utilization (CPU, Memory, Disk)
  - Database connections
  - WebSocket connections

### Database Performance Dashboard
- **Purpose**: PostgreSQL monitoring
- **Key Metrics**:
  - Active connections
  - Query performance
  - Cache hit ratio
  - Database size
  - Deadlocks and long-running queries

### Application Performance Dashboard
- **Purpose**: Service-specific monitoring
- **Key Metrics**:
  - API response times by endpoint
  - Business metrics (registrations, posts, messages)
  - User engagement metrics
  - Feed generation performance

### Security Dashboard
- **Purpose**: Security monitoring
- **Key Metrics**:
  - Failed login attempts
  - Rate limiting violations
  - Suspicious activity
  - SSL certificate status

### Business Metrics Dashboard
- **Purpose**: Product and business KPIs
- **Key Metrics**:
  - User registrations by university
  - Content creation rates
  - User engagement patterns
  - Search query trends

## Troubleshooting Guide

### Common Issues and Solutions

#### High Response Times
1. **Check CPU/Memory usage**
   ```bash
   docker stats
   ```

2. **Check database performance**
   ```sql
   SELECT query, mean_time, calls 
   FROM pg_stat_statements 
   ORDER BY mean_time DESC 
   LIMIT 10;
   ```

3. **Check slow queries**
   ```bash
   # Enable slow query log
   docker exec chitlaq-postgres psql -c "SET log_min_duration_statement = 1000;"
   ```

#### Database Connection Issues
1. **Check connection pool**
   ```bash
   docker exec chitlaq-postgres psql -c "SELECT count(*) FROM pg_stat_activity;"
   ```

2. **Check PgBouncer status**
   ```bash
   docker exec chitlaq-pgbouncer psql -h localhost -p 6432 -U pgbouncer -d pgbouncer -c "SHOW POOLS;"
   ```

3. **Restart database if needed**
   ```bash
   docker restart chitlaq-postgres
   ```

#### High Memory Usage
1. **Check memory usage by container**
   ```bash
   docker stats --no-stream
   ```

2. **Check for memory leaks**
   ```bash
   # Check Node.js heap usage
   curl http://localhost:3001/api/debug/memory
   ```

3. **Restart services if needed**
   ```bash
   docker-compose restart api-gateway web-app
   ```

#### SSL Certificate Issues
1. **Check certificate expiry**
   ```bash
   ./scripts/health-check.sh --ssl-check
   ```

2. **Renew certificate**
   ```bash
   ./scripts/ssl-setup.sh --renew
   ```

3. **Check certificate chain**
   ```bash
   openssl s_client -connect chitlaq.com:443 -showcerts
   ```

### Log Analysis

#### Application Logs
```bash
# API Gateway logs
docker logs chitlaq-api-gateway --tail 100 -f

# Web App logs
docker logs chitlaq-web-app --tail 100 -f

# Database logs
docker logs chitlaq-postgres --tail 100 -f
```

#### System Logs
```bash
# System logs
journalctl -u docker -f

# Nginx logs
docker logs chitlaq-nginx --tail 100 -f

# Security logs
tail -f /var/log/auth.log
```

#### Log Queries in Loki
```logql
# Error logs
{service="api-gateway"} |= "error"

# Slow requests
{service="api-gateway"} | json | duration > 1000

# Failed logins
{service="auth"} |= "failed login"
```

## Maintenance Procedures

### Daily Tasks
- [ ] Review overnight alerts
- [ ] Check system resource usage
- [ ] Verify backup completion
- [ ] Review security logs

### Weekly Tasks
- [ ] Update monitoring dashboards
- [ ] Review alert thresholds
- [ ] Check certificate expiry dates
- [ ] Analyze performance trends

### Monthly Tasks
- [ ] Review and update runbooks
- [ ] Conduct monitoring review
- [ ] Update alerting rules
- [ ] Performance optimization review

### Backup and Recovery

#### Database Backup
```bash
# Manual backup
./backup-scripts/backup.sh

# Verify backup
./backup-scripts/verify-backup.sh

# Test restore
./backup-scripts/test-restore.sh
```

#### Configuration Backup
```bash
# Backup configurations
tar -czf config-backup-$(date +%Y%m%d).tar.gz \
  docker-compose.yml \
  nginx/ \
  prometheus/ \
  grafana/ \
  alertmanager/
```

### Performance Tuning

#### Database Optimization
```sql
-- Update statistics
ANALYZE;

-- Check for unused indexes
SELECT schemaname, tablename, indexname, idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0;

-- Vacuum tables
VACUUM ANALYZE;
```

#### Application Optimization
```bash
# Check Node.js performance
curl http://localhost:3001/api/debug/profile

# Monitor memory usage
curl http://localhost:3001/api/debug/memory

# Check event loop lag
curl http://localhost:3001/api/debug/eventloop
```

### Security Monitoring

#### Regular Security Checks
```bash
# Check for failed logins
grep "Failed password" /var/log/auth.log | tail -20

# Check SSL certificate status
./scripts/health-check.sh --ssl-check

# Review firewall rules
iptables -L -n

# Check for suspicious activity
docker logs chitlaq-nginx | grep -i "suspicious\|blocked"
```

#### Security Incident Response
1. **Immediate containment**
2. **Preserve evidence**
3. **Notify security team**
4. **Document incident**
5. **Implement remediation**
6. **Post-incident review**

## SLA Definitions

### Availability Targets
- **API Gateway**: 99.9% uptime
- **Web Application**: 99.9% uptime
- **Database**: 99.95% uptime
- **Real-time Services**: 99.5% uptime

### Performance Targets
- **API Response Time**: < 200ms (95th percentile)
- **Database Query Time**: < 50ms (95th percentile)
- **Feed Generation**: < 500ms (95th percentile)
- **WebSocket Latency**: < 100ms (95th percentile)

### Recovery Targets
- **RTO (Recovery Time Objective)**: 1 hour
- **RPO (Recovery Point Objective)**: 15 minutes
- **MTTR (Mean Time To Recovery)**: 30 minutes

## Contact Information

### Monitoring Team
- **Primary**: monitoring@chitlaq.com
- **Slack**: #monitoring-team
- **On-Call**: +1-XXX-XXX-XXXX

### Escalation Contacts
- **Engineering Manager**: engineering@chitlaq.com
- **SRE Manager**: sre@chitlaq.com
- **CISO**: security@chitlaq.com

---

**Document Version**: 1.0  
**Last Updated**: 2024  
**Next Review**: Monthly  
**Maintained by**: ChitLaq SRE Team
