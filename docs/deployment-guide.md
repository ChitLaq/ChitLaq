# ChitLaq M1 MVP - Deployment Guide

> **Generated by PROMPT 1.5** - CI/CD Pipeline & Automated Deployment  
> **Senior DevOps Engineer** - 15+ years CI/CD and release management experience

## Table of Contents
- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Environment Setup](#environment-setup)
- [Deployment Strategies](#deployment-strategies)
- [CI/CD Pipeline](#cicd-pipeline)
- [Manual Deployment](#manual-deployment)
- [Rollback Procedures](#rollback-procedures)
- [Monitoring & Validation](#monitoring--validation)
- [Troubleshooting](#troubleshooting)
- [Best Practices](#best-practices)

## Overview

This deployment guide provides comprehensive instructions for deploying the ChitLaq M1 MVP across different environments. It covers automated CI/CD pipelines, manual deployment procedures, and operational best practices.

### Deployment Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Development   │    │     Staging     │    │   Production    │
│                 │    │                 │    │                 │
│  Local Docker   │───▶│  VPS Instance   │───▶│  VPS Instance   │
│  Compose Stack  │    │  Blue-Green     │    │  Blue-Green     │
│                 │    │  Deployment     │    │  Deployment     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Key Features
- **Automated CI/CD**: GitHub Actions with comprehensive testing
- **Blue-Green Deployment**: Zero-downtime deployments
- **Multi-Environment**: Local, staging, and production support
- **Health Monitoring**: Comprehensive health checks and validation
- **Rollback Capability**: Automated rollback on failure
- **Security Scanning**: Integrated security validation

## Prerequisites

### System Requirements

#### Minimum Requirements
- **CPU**: 4 cores
- **RAM**: 8GB
- **Storage**: 50GB SSD
- **Network**: 100 Mbps

#### Recommended Requirements
- **CPU**: 8 cores
- **RAM**: 16GB
- **Storage**: 100GB SSD
- **Network**: 1 Gbps

### Software Dependencies

#### Required Software
```bash
# Docker & Docker Compose
docker --version          # >= 20.10.0
docker-compose --version  # >= 2.0.0

# Node.js (for scripts)
node --version           # >= 18.0.0
npm --version            # >= 8.0.0

# Git
git --version            # >= 2.30.0

# SSL/TLS Tools
openssl version          # >= 1.1.1
```

#### Optional Software
```bash
# Database Tools
psql --version           # PostgreSQL client
redis-cli --version      # Redis client

# Monitoring Tools
curl --version           # HTTP client
jq --version             # JSON processor
```

### Environment Variables

#### Required Environment Variables
```bash
# Database
DATABASE_URL=postgresql://user:password@host:port/database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=chitlaq
DB_USER=postgres
DB_PASSWORD=your_password

# Redis
REDIS_URL=redis://host:port
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_password

# JWT & Auth
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=7d
AUTH_SALT_ROUNDS=12

# Supabase
SUPABASE_URL=http://localhost:8000
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_KEY=your_service_key

# Email
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email
SMTP_PASSWORD=your_password

# Monitoring
PROMETHEUS_URL=http://localhost:9090
GRAFANA_URL=http://localhost:3000
```

## Environment Setup

### 1. Local Development Environment

#### Clone Repository
```bash
git clone https://github.com/your-org/chitlaq.git
cd chitlaq
```

#### Environment Configuration
```bash
# Copy environment template
cp env.example .env

# Edit environment variables
nano .env
```

#### Start Local Stack
```bash
# Start all services
docker-compose up -d

# Verify services
docker-compose ps
```

#### Run Health Checks
```bash
# Basic health checks
./deployment/health-checks.sh --env local

# Comprehensive health checks
./deployment/health-checks.sh --env local --comprehensive --verbose
```

### 2. Staging Environment

#### VPS Setup
```bash
# Connect to staging VPS
ssh user@staging.chitlaq.com

# Create deployment directory
sudo mkdir -p /opt/chitlaq
sudo chown $USER:$USER /opt/chitlaq

# Clone repository
cd /opt/chitlaq
git clone https://github.com/your-org/chitlaq.git .

# Setup environment
cp env.example .env
nano .env  # Configure staging-specific values
```

#### SSL Certificate Setup
```bash
# Run SSL setup script
./scripts/ssl-setup.sh --domain staging.chitlaq.com

# Verify SSL certificate
openssl s_client -connect staging.chitlaq.com:443 -servername staging.chitlaq.com
```

#### Security Hardening
```bash
# Run security hardening script
sudo ./scripts/security-hardening.sh

# Configure firewall
sudo ./scripts/firewall-config.sh
```

### 3. Production Environment

#### VPS Setup
```bash
# Connect to production VPS
ssh user@chitlaq.com

# Create deployment directory
sudo mkdir -p /opt/chitlaq/production
sudo chown $USER:$USER /opt/chitlaq/production

# Clone repository
cd /opt/chitlaq/production
git clone https://github.com/your-org/chitlaq.git .

# Setup environment
cp env.example .env
nano .env  # Configure production-specific values
```

#### Production Security
```bash
# Run comprehensive security setup
sudo ./scripts/security-hardening.sh --production
sudo ./scripts/firewall-config.sh --production

# Setup SSL with Let's Encrypt
./scripts/ssl-setup.sh --domain chitlaq.com --production
```

## Deployment Strategies

### 1. Blue-Green Deployment

Blue-green deployment ensures zero-downtime deployments by maintaining two identical production environments.

#### Architecture
```
┌─────────────┐    ┌─────────────┐
│   Load      │    │   Blue      │
│  Balancer   │───▶│ Environment │
│             │    │ (Current)   │
└─────────────┘    └─────────────┘
                           │
                           ▼
                   ┌─────────────┐
                   │   Green     │
                   │ Environment │
                   │ (Standby)   │
                   └─────────────┘
```

#### Implementation
```bash
# Deploy to green environment
export COMPOSE_PROJECT_NAME="chitlaq-green"
docker-compose up -d

# Run health checks
./deployment/health-checks.sh --env production --comprehensive

# Switch traffic (update load balancer)
# Update nginx configuration
sudo nginx -s reload

# Stop blue environment
export COMPOSE_PROJECT_NAME="chitlaq-blue"
docker-compose down
```

### 2. Rolling Deployment

Rolling deployment updates services one at a time with minimal downtime.

#### Implementation
```bash
# Update services one by one
docker-compose up -d --no-deps api-gateway
sleep 30
./deployment/health-checks.sh --env production

docker-compose up -d --no-deps web-app
sleep 30
./deployment/health-checks.sh --env production

# Continue for all services...
```

### 3. Canary Deployment

Canary deployment gradually shifts traffic to the new version.

#### Implementation
```bash
# Deploy new version alongside current
docker-compose -f docker-compose.yml -f docker-compose.canary.yml up -d

# Route 10% traffic to canary
# Update load balancer configuration
# Monitor metrics

# Gradually increase traffic (10% → 50% → 100%)
# Full deployment after validation
```

## CI/CD Pipeline

### 1. GitHub Actions Workflow

#### Continuous Integration (CI)
```yaml
# .github/workflows/ci.yml
name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Run linting
        run: npm run lint
      - name: Run tests
        run: npm run test
```

#### Continuous Deployment (CD)
```yaml
# .github/workflows/cd-staging.yml
name: Deploy to Staging

on:
  push:
    branches: [ develop ]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to staging
        run: ./scripts/deploy-staging.sh --deployment-id ${{ github.sha }}
```

### 2. Pipeline Stages

#### Stage 1: Code Quality
- **Linting**: ESLint, Prettier, Go fmt, Rust fmt
- **Type Checking**: TypeScript compilation
- **Security Scanning**: Snyk, CodeQL, Trivy
- **Dependency Audit**: npm audit, go mod verify

#### Stage 2: Testing
- **Unit Tests**: Jest, Go test, Cargo test
- **Integration Tests**: API testing, database testing
- **E2E Tests**: Playwright, Cypress
- **Performance Tests**: Load testing, stress testing

#### Stage 3: Build & Package
- **Docker Build**: Multi-stage builds
- **Image Scanning**: Vulnerability scanning
- **Artifact Storage**: Docker registry
- **SBOM Generation**: Software bill of materials

#### Stage 4: Deployment
- **Staging Deployment**: Automated deployment
- **Health Checks**: Comprehensive validation
- **Smoke Tests**: Critical path testing
- **Performance Validation**: Response time checks

#### Stage 5: Production
- **Approval Gate**: Manual approval required
- **Blue-Green Deployment**: Zero-downtime deployment
- **Traffic Switching**: Gradual traffic migration
- **Monitoring**: Real-time health monitoring

### 3. Pipeline Triggers

#### Automatic Triggers
- **Push to develop**: Deploy to staging
- **Push to main**: Deploy to production (with approval)
- **Pull Request**: Run CI pipeline
- **Schedule**: Daily security scans

#### Manual Triggers
- **Emergency Deployment**: Force deployment
- **Hotfix**: Direct production deployment
- **Rollback**: Automated rollback trigger

## Manual Deployment

### 1. Staging Deployment

#### Prerequisites
```bash
# Ensure you're on the correct branch
git checkout develop
git pull origin develop

# Verify environment configuration
cat .env | grep -E "^(ENVIRONMENT|BASE_URL)="
```

#### Deployment Steps
```bash
# 1. Create deployment ID
export DEPLOYMENT_ID=$(date +%Y%m%d-%H%M%S)
echo "Deployment ID: $DEPLOYMENT_ID"

# 2. Run pre-deployment checks
./scripts/validate-config.js staging

# 3. Deploy to staging
./scripts/deploy-staging.sh --deployment-id $DEPLOYMENT_ID --blue-green

# 4. Run health checks
./deployment/health-checks.sh --env staging --comprehensive

# 5. Run smoke tests
npm run test:smoke:staging

# 6. Verify deployment
curl -f https://staging.chitlaq.com/health
```

#### Validation
```bash
# Test critical endpoints
curl -f https://staging.chitlaq.com/api/health
curl -f https://staging.chitlaq.com/api/feed
curl -f https://staging.chitlaq.com/api/search?q=test

# Check database connectivity
./scripts/test-db-connection.js --env staging

# Verify WebSocket functionality
./scripts/test-websocket.js --env staging
```

### 2. Production Deployment

#### Prerequisites
```bash
# Ensure staging deployment is successful
curl -f https://staging.chitlaq.com/health

# Verify you're on the correct branch
git checkout main
git pull origin main

# Check production environment
cat .env | grep -E "^(ENVIRONMENT|BASE_URL)="
```

#### Deployment Steps
```bash
# 1. Create deployment ID
export DEPLOYMENT_ID=$(date +%Y%m%d-%H%M%S)
echo "Deployment ID: $DEPLOYMENT_ID"

# 2. Enable maintenance mode (optional)
./scripts/enable-maintenance-mode.sh

# 3. Create production backup
./backup-scripts/backup.sh --env production --pre-migration

# 4. Deploy to production
./scripts/deploy-production.sh --deployment-id $DEPLOYMENT_ID --blue-green --maintenance

# 5. Run comprehensive health checks
./deployment/health-checks.sh --env production --comprehensive --timeout 300

# 6. Run production smoke tests
npm run test:smoke:production

# 7. Disable maintenance mode
./scripts/disable-maintenance-mode.sh

# 8. Verify deployment
curl -f https://chitlaq.com/health
```

#### Post-Deployment Validation
```bash
# Test all critical endpoints
curl -f https://chitlaq.com/api/health
curl -f https://chitlaq.com/api/feed
curl -f https://chitlaq.com/api/search?q=test
curl -f https://chitlaq.com/api/auth/status

# Check monitoring dashboards
curl -f https://chitlaq.com/grafana/api/health
curl -f https://chitlaq.com/metrics

# Verify SSL certificate
openssl s_client -connect chitlaq.com:443 -servername chitlaq.com

# Test user flows
./scripts/test-user-flow.js --env production --flow=registration
./scripts/test-user-flow.js --env production --flow=login
./scripts/test-user-flow.js --env production --flow=post-creation
```

## Rollback Procedures

### 1. Automated Rollback

#### Trigger Conditions
- Health checks fail after deployment
- Error rate exceeds threshold
- Response time exceeds SLA
- Critical functionality broken

#### Rollback Process
```bash
# Automatic rollback (triggered by CI/CD)
./scripts/rollback.sh --environment production --force

# Manual rollback
./scripts/rollback.sh --environment production --version 20241201-143022
```

### 2. Manual Rollback

#### Emergency Rollback
```bash
# 1. Stop current services
docker-compose down

# 2. Switch to previous deployment
ln -sfn /opt/chitlaq/production/deployments/20241201-143022 /opt/chitlaq/production/current

# 3. Start previous services
cd /opt/chitlaq/production/current
docker-compose up -d

# 4. Verify rollback
./deployment/health-checks.sh --env production
curl -f https://chitlaq.com/health
```

#### Database Rollback
```bash
# 1. Stop application services
docker-compose stop api-gateway web-app

# 2. Restore database from backup
./backup-scripts/restore.sh --backup-file backup-20241201-143022.sql.gpg

# 3. Restart services
docker-compose start api-gateway web-app

# 4. Verify rollback
./deployment/health-checks.sh --env production
```

### 3. Rollback Validation

#### Health Checks
```bash
# Run comprehensive health checks
./deployment/health-checks.sh --env production --comprehensive

# Test critical functionality
curl -f https://chitlaq.com/api/health
curl -f https://chitlaq.com/api/feed
curl -f https://chitlaq.com/api/search?q=test
```

#### User Flow Testing
```bash
# Test critical user flows
./scripts/test-user-flow.js --env production --flow=login
./scripts/test-user-flow.js --env production --flow=post-creation
./scripts/test-user-flow.js --env production --flow=messaging
```

## Monitoring & Validation

### 1. Health Monitoring

#### Health Check Endpoints
```bash
# Application health
curl -f https://chitlaq.com/health
curl -f https://chitlaq.com/api/health

# Service-specific health
curl -f https://chitlaq.com/api/auth/status
curl -f https://chitlaq.com/api/feed/health
curl -f https://chitlaq.com/api/search/health
```

#### Comprehensive Health Checks
```bash
# Run all health checks
./deployment/health-checks.sh --env production --comprehensive --verbose

# Output in different formats
./deployment/health-checks.sh --env production --format json
./deployment/health-checks.sh --env production --format xml
```

### 2. Performance Monitoring

#### Response Time Monitoring
```bash
# Test response times
curl -w "@curl-format.txt" -o /dev/null -s https://chitlaq.com/api/health
curl -w "@curl-format.txt" -o /dev/null -s https://chitlaq.com/api/feed
curl -w "@curl-format.txt" -o /dev/null -s https://chitlaq.com/api/search?q=test
```

#### Load Testing
```bash
# Run performance tests
node benchmarks/performance-tests.js production baseline
node benchmarks/performance-tests.js production load
node benchmarks/performance-tests.js production stress
```

### 3. Monitoring Dashboards

#### Grafana Dashboards
- **System Overview**: CPU, Memory, Disk, Network
- **Application Metrics**: Response times, error rates, throughput
- **Database Performance**: Query times, connections, cache hit ratio
- **Business Metrics**: User registrations, posts, messages

#### Prometheus Metrics
```bash
# Check Prometheus targets
curl -f https://chitlaq.com/metrics

# Query specific metrics
curl -f "https://chitlaq.com/prometheus/api/v1/query?query=up"
curl -f "https://chitlaq.com/prometheus/api/v1/query?query=http_requests_total"
```

## Troubleshooting

### 1. Common Issues

#### Service Won't Start
```bash
# Check Docker logs
docker-compose logs service-name

# Check service status
docker-compose ps

# Restart service
docker-compose restart service-name
```

#### Database Connection Issues
```bash
# Check database connectivity
docker-compose exec postgres pg_isready -U postgres

# Check database logs
docker-compose logs postgres

# Test database connection
docker-compose exec postgres psql -U postgres -d chitlaq -c "SELECT 1;"
```

#### SSL Certificate Issues
```bash
# Check certificate expiry
openssl s_client -connect chitlaq.com:443 -servername chitlaq.com | openssl x509 -noout -dates

# Renew certificate
./scripts/ssl-setup.sh --renew

# Check certificate chain
openssl s_client -connect chitlaq.com:443 -servername chitlaq.com -showcerts
```

### 2. Performance Issues

#### High Response Times
```bash
# Check system resources
docker stats
free -h
df -h

# Check database performance
docker-compose exec postgres psql -U postgres -d chitlaq -c "SELECT * FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"

# Check slow queries
docker-compose exec postgres psql -U postgres -d chitlaq -c "SELECT query, mean_time, calls FROM pg_stat_statements WHERE mean_time > 1000 ORDER BY mean_time DESC;"
```

#### Memory Issues
```bash
# Check memory usage
docker stats --no-stream
free -h

# Check for memory leaks
curl -f https://chitlaq.com/api/debug/memory

# Restart services if needed
docker-compose restart api-gateway web-app
```

### 3. Security Issues

#### Failed Login Attempts
```bash
# Check authentication logs
docker-compose logs api-gateway | grep "failed login"

# Check rate limiting
curl -f https://chitlaq.com/api/auth/status

# Review security logs
tail -f /var/log/auth.log | grep "Failed password"
```

#### SSL/TLS Issues
```bash
# Test SSL configuration
./scripts/ssl-test.js --env production

# Check security headers
./scripts/security-headers-test.js --env production

# Test rate limiting
./scripts/rate-limit-test.js --env production
```

## Best Practices

### 1. Deployment Best Practices

#### Pre-Deployment
- **Always test in staging first**
- **Create backups before deployment**
- **Verify environment configuration**
- **Run comprehensive health checks**
- **Review security scans**

#### During Deployment
- **Use blue-green deployment for production**
- **Monitor health checks continuously**
- **Have rollback plan ready**
- **Communicate with team**
- **Document deployment steps**

#### Post-Deployment
- **Verify all critical functionality**
- **Monitor performance metrics**
- **Check error rates**
- **Validate user flows**
- **Update documentation**

### 2. Security Best Practices

#### Environment Security
- **Use strong passwords and secrets**
- **Enable SSL/TLS everywhere**
- **Implement rate limiting**
- **Regular security updates**
- **Monitor security logs**

#### Deployment Security
- **Scan images for vulnerabilities**
- **Use signed containers**
- **Implement least privilege**
- **Encrypt sensitive data**
- **Regular security audits**

### 3. Monitoring Best Practices

#### Health Monitoring
- **Comprehensive health checks**
- **Real-time monitoring**
- **Automated alerting**
- **Performance baselines**
- **Regular health reports**

#### Incident Response
- **Clear escalation procedures**
- **Automated rollback triggers**
- **Incident documentation**
- **Post-mortem analysis**
- **Continuous improvement**

### 4. Operational Best Practices

#### Documentation
- **Keep deployment guides updated**
- **Document all procedures**
- **Maintain runbooks**
- **Version control documentation**
- **Regular review cycles**

#### Team Collaboration
- **Clear communication channels**
- **Shared responsibility**
- **Knowledge sharing**
- **Regular training**
- **Continuous learning**

---

**Document Version**: 1.0  
**Last Updated**: 2024  
**Next Review**: Monthly  
**Maintained by**: ChitLaq DevOps Team
