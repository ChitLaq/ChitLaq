# ChitLaq M1 MVP - System Architecture Overview

> **Generated by PROMPT 1.7** - Infrastructure Documentation & Knowledge Transfer  
> **Senior Technical Writer & Infrastructure Architect** - 15+ years system documentation and knowledge transfer experience

## Executive Summary

This document provides a comprehensive overview of the ChitLaq M1 MVP system architecture, including all infrastructure components, service interdependencies, and architectural decisions. This serves as the foundation for understanding the entire system and guides operational procedures, troubleshooting, and future development.

## Table of Contents
- [System Overview](#system-overview)
- [Architecture Principles](#architecture-principles)
- [Technology Stack](#technology-stack)
- [Infrastructure Components](#infrastructure-components)
- [Service Architecture](#service-architecture)
- [Data Flow Architecture](#data-flow-architecture)
- [Security Architecture](#security-architecture)
- [Monitoring Architecture](#monitoring-architecture)
- [Deployment Architecture](#deployment-architecture)
- [Scalability Architecture](#scalability-architecture)
- [Architecture Decision Records](#architecture-decision-records)

## System Overview

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        ChitLaq M1 MVP                          │
│                    Social Media Platform                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Load Balancer (Nginx)                       │
│              SSL Termination & Request Routing                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌─────────────────────┐ ┌─────────────────┐ ┌─────────────────────┐
│   API Gateway       │ │  WebSocket      │ │   Static Assets     │
│   (Fastify)         │ │  (Bun + uWS)    │ │   (CDN)             │
│   Port: 3001        │ │  Port: 3002     │ │   Cloudflare        │
└─────────────────────┘ └─────────────────┘ └─────────────────────┘
                │               │
                ▼               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Application Services                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐│
│  │   Auth      │ │   Feed      │ │  Messaging  │ │   Search    ││
│  │  Service    │ │  Service    │ │   Service   │ │   Service   ││
│  │ (Fastify)   │ │   (Go)      │ │   (Bun)     │ │  (Rust)     ││
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘│
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌─────────────────────┐ ┌─────────────────┐ ┌─────────────────────┐
│   Supabase Stack    │ │   Redis Cache   │ │   File Storage      │
│   (Self-hosted)     │ │   (Session &    │ │   (Local + CDN)     │
│   - PostgreSQL      │ │    Hot Data)    │ │                     │
│   - Auth            │ │   Port: 6379    │ │                     │
│   - Realtime        │ │                 │ │                     │
│   - Storage         │ │                 │ │                     │
│   - Studio          │ │                 │ │                     │
└─────────────────────┘ └─────────────────┘ └─────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌─────────────────────┐ ┌─────────────────┐ ┌─────────────────────┐
│   Monitoring        │ │   Logging       │ │   Backup            │
│   (Prometheus +     │ │   (Loki +       │ │   (Automated        │
│    Grafana)         │ │    Fluentd)     │ │    PostgreSQL)      │
│   Port: 9090        │ │   Port: 3100    │ │   Daily + Encrypted │
└─────────────────────┘ └─────────────────┘ └─────────────────────┘
```

### System Characteristics
- **Architecture Type**: Hybrid Monorepo with Microservices
- **Deployment Model**: Single VPS with Docker Compose
- **Scalability**: Vertical scaling with horizontal scaling preparation
- **Availability**: 99.9% target uptime
- **Performance**: <150ms API response time, <100ms WebSocket latency
- **Security**: Multi-layered security with encryption and monitoring

## Architecture Principles

### 1. Performance-First Design
- **Fast Languages**: Go for feed algorithms, Rust for search, Bun for real-time
- **Optimized Queries**: Database indexing and query optimization
- **Caching Strategy**: Multi-tier caching (Memory → Redis → Database)
- **CDN Integration**: Global content delivery for static assets

### 2. Scalability and Flexibility
- **Microservices**: Independent services for different domains
- **Containerization**: Docker for consistent deployment
- **Load Balancing**: Nginx for request distribution
- **Horizontal Scaling**: Prepared for multi-instance deployment

### 3. Security by Design
- **Defense in Depth**: Multiple security layers
- **Encryption**: TLS 1.3, database encryption, backup encryption
- **Authentication**: JWT with Supabase Auth
- **Monitoring**: Comprehensive security monitoring and alerting

### 4. Observability and Monitoring
- **Metrics**: Prometheus for system and application metrics
- **Logging**: Centralized logging with Loki
- **Tracing**: OpenTelemetry for distributed tracing
- **Alerting**: Multi-tier alerting with Alertmanager

### 5. Reliability and Resilience
- **Health Checks**: Comprehensive health monitoring
- **Backup Strategy**: Automated encrypted backups
- **Disaster Recovery**: RTO < 4 hours, RPO < 1 hour
- **Graceful Degradation**: Fallback mechanisms for critical services

## Technology Stack

### Backend Services
| Service | Technology | Purpose | Port |
|---------|------------|---------|------|
| API Gateway | Fastify + Node.js | Request routing, authentication | 3001 |
| WebSocket | Bun + uWebSockets.js | Real-time messaging | 3002 |
| Feed Service | Go + Gin | Feed algorithms and generation | 3003 |
| Search Service | Rust + Actix Web | Search functionality | 3004 |
| Auth Service | Fastify + Supabase Auth | Authentication and authorization | 3005 |

### Data Layer
| Component | Technology | Purpose | Port |
|-----------|------------|---------|------|
| Database | PostgreSQL 15 | Primary data storage | 5432 |
| Cache | Redis 7 | Session and hot data caching | 6379 |
| Storage | Local + CDN | File and image storage | - |

### Infrastructure
| Component | Technology | Purpose | Port |
|-----------|------------|---------|------|
| Load Balancer | Nginx | SSL termination, routing | 80, 443 |
| Reverse Proxy | Nginx | Service routing | 80, 443 |
| Container Runtime | Docker | Service containerization | - |
| Orchestration | Docker Compose | Service orchestration | - |

### Monitoring & Observability
| Component | Technology | Purpose | Port |
|-----------|------------|---------|------|
| Metrics | Prometheus | Metrics collection | 9090 |
| Visualization | Grafana | Metrics visualization | 3000 |
| Alerting | Alertmanager | Alert management | 9093 |
| Logging | Loki | Log aggregation | 3100 |
| Tracing | OpenTelemetry | Distributed tracing | - |

### Security
| Component | Technology | Purpose |
|-----------|------------|---------|
| SSL/TLS | Let's Encrypt | Certificate management |
| Firewall | iptables | Network security |
| Intrusion Detection | Fail2ban | Attack prevention |
| Audit | Auditd | Security auditing |

## Infrastructure Components

### 1. Load Balancer (Nginx)
**Purpose**: SSL termination, request routing, and load distribution

**Configuration**:
- SSL/TLS termination with Let's Encrypt certificates
- HTTP/2 support for improved performance
- Rate limiting and DDoS protection
- Security headers and CORS configuration
- Static file serving and caching

**Key Features**:
- Automatic SSL certificate renewal
- Health check integration
- Request/response logging
- Compression and optimization

### 2. API Gateway (Fastify)
**Purpose**: Central entry point for all API requests

**Responsibilities**:
- Request authentication and authorization
- Rate limiting and throttling
- Request/response transformation
- Service discovery and routing
- API versioning and documentation

**Key Features**:
- JWT token validation
- Request logging and metrics
- Error handling and transformation
- CORS and security headers

### 3. WebSocket Service (Bun + uWebSockets.js)
**Purpose**: Real-time messaging and notifications

**Responsibilities**:
- WebSocket connection management
- Message broadcasting and routing
- Connection pooling and scaling
- Heartbeat and health monitoring
- Message queuing and delivery

**Key Features**:
- High-performance WebSocket handling
- Message compression and batching
- Connection state management
- Real-time metrics and monitoring

### 4. Supabase Stack (Self-hosted)
**Purpose**: Complete backend-as-a-service solution

**Components**:
- **PostgreSQL**: Primary database with extensions
- **Auth**: User authentication and management
- **Realtime**: Real-time subscriptions and updates
- **Storage**: File and image storage
- **Studio**: Database management interface
- **Kong**: API gateway and management
- **PostgREST**: Auto-generated REST API

### 5. Redis Cache
**Purpose**: High-performance caching and session storage

**Use Cases**:
- User session management
- API response caching
- Hot data caching
- Rate limiting counters
- Message queuing

**Configuration**:
- Memory optimization
- Persistence configuration
- Cluster setup (future)
- Monitoring and alerting

### 6. Monitoring Stack
**Purpose**: Comprehensive system observability

**Components**:
- **Prometheus**: Metrics collection and storage
- **Grafana**: Metrics visualization and dashboards
- **Alertmanager**: Alert routing and notification
- **Loki**: Log aggregation and analysis
- **OpenTelemetry**: Distributed tracing

## Service Architecture

### 1. Authentication Service
**Technology**: Fastify + Supabase Auth
**Port**: 3005

**Responsibilities**:
- User registration and login
- JWT token generation and validation
- Password reset and email verification
- University email validation
- User profile management

**API Endpoints**:
- `POST /auth/register` - User registration
- `POST /auth/login` - User login
- `POST /auth/logout` - User logout
- `POST /auth/refresh` - Token refresh
- `GET /auth/me` - Current user info

### 2. Feed Service
**Technology**: Go + Gin
**Port**: 3003

**Responsibilities**:
- Home feed generation
- Explore feed algorithms
- Trending content calculation
- Feed personalization
- Content recommendation

**API Endpoints**:
- `GET /feed/home` - User's home feed
- `GET /feed/explore` - Explore feed
- `GET /feed/trending` - Trending content
- `GET /feed/recommendations` - Content recommendations

### 3. Messaging Service
**Technology**: Bun + uWebSockets.js
**Port**: 3002

**Responsibilities**:
- Real-time messaging
- Conversation management
- Message history
- Online status tracking
- Message delivery confirmation

**WebSocket Events**:
- `message` - Send/receive messages
- `typing` - Typing indicators
- `online` - User online status
- `conversation` - Conversation updates

### 4. Search Service
**Technology**: Rust + Actix Web
**Port**: 3004

**Responsibilities**:
- Full-text search
- User search
- Post search
- Hashtag search
- Search suggestions

**API Endpoints**:
- `GET /search/users` - Search users
- `GET /search/posts` - Search posts
- `GET /search/hashtags` - Search hashtags
- `GET /search/suggestions` - Search suggestions

## Data Flow Architecture

### 1. User Registration Flow
```
User → Nginx → API Gateway → Auth Service → Supabase Auth → PostgreSQL
                ↓
            Redis Cache (Session)
                ↓
            Response → User
```

### 2. Feed Generation Flow
```
User → Nginx → API Gateway → Feed Service → PostgreSQL
                ↓                    ↓
            Redis Cache ← ← ← ← ← ← ← ←
                ↓
            Response → User
```

### 3. Real-time Messaging Flow
```
User → WebSocket Service → PostgreSQL
         ↓
    Redis Cache (Message Queue)
         ↓
    Broadcast to Connected Users
```

### 4. Search Flow
```
User → Nginx → API Gateway → Search Service → PostgreSQL
                ↓                    ↓
            Redis Cache ← ← ← ← ← ← ← ←
                ↓
            Response → User
```

## Security Architecture

### 1. Network Security
- **Firewall**: iptables rules for port filtering
- **SSL/TLS**: TLS 1.3 with strong ciphers
- **DDoS Protection**: Rate limiting and connection limits
- **VPN Access**: Secure administrative access

### 2. Application Security
- **Authentication**: JWT with Supabase Auth
- **Authorization**: Role-based access control (RBAC)
- **Input Validation**: Comprehensive input sanitization
- **SQL Injection**: Parameterized queries and ORM

### 3. Data Security
- **Encryption at Rest**: Database and backup encryption
- **Encryption in Transit**: TLS for all communications
- **Data Masking**: Sensitive data protection
- **Audit Logging**: Comprehensive audit trails

### 4. Infrastructure Security
- **Container Security**: Docker security best practices
- **OS Hardening**: System security hardening
- **Intrusion Detection**: Fail2ban and monitoring
- **Vulnerability Management**: Regular security updates

## Monitoring Architecture

### 1. Metrics Collection
- **System Metrics**: CPU, memory, disk, network
- **Application Metrics**: Response times, error rates, throughput
- **Business Metrics**: User registrations, posts, messages
- **Custom Metrics**: Application-specific KPIs

### 2. Logging Strategy
- **Application Logs**: Structured JSON logging
- **Access Logs**: Nginx access and error logs
- **System Logs**: OS and service logs
- **Security Logs**: Authentication and authorization logs

### 3. Alerting Strategy
- **Critical Alerts**: Immediate response required
- **Warning Alerts**: Response within 1 hour
- **Info Alerts**: Response within 24 hours
- **Escalation**: Multi-tier escalation procedures

### 4. Dashboards
- **System Overview**: High-level system health
- **Application Performance**: API and service metrics
- **Database Performance**: Query and connection metrics
- **Security Monitoring**: Security events and threats

## Deployment Architecture

### 1. Single VPS Deployment
- **Host**: Hetzner CPX21 (3 vCPU, 8GB RAM, 160GB SSD)
- **OS**: Ubuntu 22.04 LTS
- **Containerization**: Docker with Docker Compose
- **Networking**: Private network with public access

### 2. Service Deployment
- **Container Registry**: Local Docker registry
- **Service Discovery**: Docker Compose networking
- **Health Checks**: Container and service health monitoring
- **Rolling Updates**: Zero-downtime deployments

### 3. Configuration Management
- **Environment Variables**: Secure configuration management
- **Secrets Management**: Encrypted secrets storage
- **Configuration Validation**: Startup configuration checks
- **Version Control**: Infrastructure as Code

### 4. CI/CD Pipeline
- **Source Control**: GitHub with branch protection
- **Build Pipeline**: Automated testing and building
- **Deployment Pipeline**: Automated deployment to staging/production
- **Rollback Strategy**: Automated rollback capabilities

## Scalability Architecture

### 1. Vertical Scaling (Current)
- **CPU Scaling**: Upgrade to higher CPU instances
- **Memory Scaling**: Increase RAM for better performance
- **Storage Scaling**: Add more storage capacity
- **Network Scaling**: Upgrade network bandwidth

### 2. Horizontal Scaling (Future)
- **Load Balancing**: Multiple application instances
- **Database Scaling**: Read replicas and sharding
- **Cache Scaling**: Redis cluster implementation
- **Service Scaling**: Independent service scaling

### 3. Auto-scaling Strategy
- **Metrics-based**: CPU, memory, and request metrics
- **Time-based**: Scheduled scaling for known patterns
- **Predictive**: Machine learning-based scaling
- **Cost Optimization**: Balance performance and cost

## Architecture Decision Records

### ADR-001: Technology Stack Selection
**Decision**: Use performance-first technology stack with Go, Rust, and Bun
**Rationale**: Optimize for performance in high-load scenarios
**Consequences**: Higher complexity but better performance
**Status**: Accepted

### ADR-002: Single VPS Deployment
**Decision**: Deploy on single VPS with Docker Compose
**Rationale**: Cost optimization for M1 MVP with $100/month budget
**Consequences**: Limited scalability but cost-effective
**Status**: Accepted

### ADR-003: Self-hosted Supabase
**Decision**: Self-host Supabase instead of managed service
**Rationale**: Cost control and full control over infrastructure
**Consequences**: Higher operational overhead but lower cost
**Status**: Accepted

### ADR-004: Hybrid Monorepo Architecture
**Decision**: Use hybrid monorepo with microservices
**Rationale**: Balance between monorepo benefits and microservices flexibility
**Consequences**: Complex deployment but good development experience
**Status**: Accepted

### ADR-005: Comprehensive Monitoring
**Decision**: Implement full observability stack
**Rationale**: Essential for production operations and debugging
**Consequences**: Higher complexity but better operational visibility
**Status**: Accepted

## Future Recommendations

### 1. Short-term (3-6 months)
- **Performance Optimization**: Implement all optimization recommendations
- **Monitoring Enhancement**: Add more business metrics
- **Security Hardening**: Implement additional security measures
- **Documentation**: Complete operational runbooks

### 2. Medium-term (6-12 months)
- **Horizontal Scaling**: Implement multi-instance deployment
- **Database Optimization**: Add read replicas and sharding
- **CDN Implementation**: Global content delivery
- **Advanced Monitoring**: Machine learning-based monitoring

### 3. Long-term (12+ months)
- **Microservices Evolution**: Full microservices architecture
- **Cloud Migration**: Consider cloud provider migration
- **Advanced Analytics**: Real-time analytics and insights
- **Global Deployment**: Multi-region deployment

## Conclusion

The ChitLaq M1 MVP system architecture provides a solid foundation for a scalable, secure, and performant social media platform. The hybrid monorepo approach with performance-first technology choices ensures optimal performance while maintaining development efficiency.

Key architectural strengths:
1. **Performance-Optimized**: Fast languages and optimized queries
2. **Cost-Effective**: Single VPS deployment with room for scaling
3. **Secure**: Multi-layered security with comprehensive monitoring
4. **Observable**: Full observability stack for operations
5. **Scalable**: Prepared for both vertical and horizontal scaling

The architecture supports the M1 MVP requirements while providing a clear path for future growth and scaling. All components are production-ready with comprehensive monitoring, security, and operational procedures.

---

**Document Version**: 1.0  
**Last Updated**: 2024  
**Next Review**: Monthly  
**Maintained by**: ChitLaq Architecture Team
