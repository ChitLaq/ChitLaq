# ChitLaq M1 MVP - Infrastructure Setup Guide

> **Generated by PROMPT 1.7** - Infrastructure Documentation & Knowledge Transfer  
> **Senior Technical Writer & Infrastructure Architect** - 15+ years system documentation and knowledge transfer experience

## Executive Summary

This guide provides comprehensive instructions for setting up the ChitLaq M1 MVP infrastructure from scratch. It covers server provisioning, software installation, configuration, and deployment procedures. This document serves as the definitive guide for infrastructure setup and maintenance.

## Table of Contents
- [Prerequisites](#prerequisites)
- [Server Provisioning](#server-provisioning)
- [System Preparation](#system-preparation)
- [Docker Installation](#docker-installation)
- [Infrastructure Deployment](#infrastructure-deployment)
- [Service Configuration](#service-configuration)
- [SSL/TLS Setup](#ssltls-setup)
- [Security Hardening](#security-hardening)
- [Monitoring Setup](#monitoring-setup)
- [Backup Configuration](#backup-configuration)
- [Verification and Testing](#verification-and-testing)
- [Troubleshooting](#troubleshooting)

## Prerequisites

### System Requirements
- **VPS Provider**: Hetzner Cloud (recommended) or equivalent
- **Instance Type**: CPX21 or higher (3 vCPU, 8GB RAM, 160GB SSD)
- **Operating System**: Ubuntu 22.04 LTS
- **Network**: Public IP with 20TB bandwidth
- **Budget**: $100/month

### Required Tools
- **SSH Client**: OpenSSH or equivalent
- **Domain Name**: Registered domain for SSL certificates
- **DNS Access**: Ability to configure DNS records
- **Git**: Version control system
- **Docker**: Container runtime
- **Docker Compose**: Container orchestration

### Access Requirements
- **Root Access**: Full administrative access to VPS
- **Domain Control**: DNS management access
- **Email Access**: For SSL certificate validation

## Server Provisioning

### 1. VPS Selection and Setup

#### Hetzner Cloud Setup
```bash
# Create new project in Hetzner Cloud Console
# Select CPX21 instance type
# Choose Ubuntu 22.04 LTS
# Select appropriate datacenter (Nuremberg recommended)
# Configure SSH key authentication
# Set hostname: chitlaq-mvp
```

#### Initial Server Access
```bash
# Connect to server
ssh root@YOUR_SERVER_IP

# Update system
apt update && apt upgrade -y

# Set hostname
hostnamectl set-hostname chitlaq-mvp

# Configure timezone
timedatectl set-timezone UTC
```

### 2. Network Configuration

#### Firewall Setup
```bash
# Install UFW
apt install ufw -y

# Configure basic firewall rules
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 3000:3005/tcp  # Application ports
ufw allow 5432/tcp       # PostgreSQL (if external access needed)
ufw allow 6379/tcp       # Redis (if external access needed)
ufw allow 9090/tcp       # Prometheus
ufw allow 3000/tcp       # Grafana

# Enable firewall
ufw --force enable
```

#### Network Optimization
```bash
# Configure network parameters
cat >> /etc/sysctl.conf << EOF
# Network optimizations
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 65536 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_congestion_control = bbr
EOF

# Apply changes
sysctl -p
```

## System Preparation

### 1. User and Security Setup

#### Create Application User
```bash
# Create application user
useradd -m -s /bin/bash chitlaq
usermod -aG sudo chitlaq

# Set up SSH key for chitlaq user
mkdir -p /home/chitlaq/.ssh
cp /root/.ssh/authorized_keys /home/chitlaq/.ssh/
chown -R chitlaq:chitlaq /home/chitlaq/.ssh
chmod 700 /home/chitlaq/.ssh
chmod 600 /home/chitlaq/.ssh/authorized_keys

# Switch to chitlaq user
su - chitlaq
```

#### SSH Security Hardening
```bash
# Edit SSH configuration
sudo nano /etc/ssh/sshd_config

# Add/modify these settings:
# Port 2222
# PermitRootLogin no
# PasswordAuthentication no
# PubkeyAuthentication yes
# MaxAuthTries 3
# ClientAliveInterval 300
# ClientAliveCountMax 2

# Restart SSH service
sudo systemctl restart sshd
```

### 2. System Optimization

#### Kernel Parameters
```bash
# Add kernel optimizations
sudo tee -a /etc/sysctl.conf << EOF
# File system optimizations
fs.file-max = 2097152
fs.inotify.max_user_watches = 524288

# Memory optimizations
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# Network optimizations
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_syncookies = 1
EOF

# Apply changes
sudo sysctl -p
```

#### System Limits
```bash
# Configure system limits
sudo tee -a /etc/security/limits.conf << EOF
# Application user limits
chitlaq soft nofile 65536
chitlaq hard nofile 65536
chitlaq soft nproc 32768
chitlaq hard nproc 32768

# Root limits
root soft nofile 65536
root hard nofile 65536
root soft nproc 32768
root hard nproc 32768
EOF
```

## Docker Installation

### 1. Docker Engine Installation

#### Install Docker
```bash
# Update package index
sudo apt update

# Install required packages
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

# Add Docker's official GPG key
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Add Docker repository
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Update package index
sudo apt update

# Install Docker Engine
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Add user to docker group
sudo usermod -aG docker chitlaq

# Enable and start Docker
sudo systemctl enable docker
sudo systemctl start docker
```

#### Docker Configuration
```bash
# Create Docker daemon configuration
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json << EOF
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "live-restore": true,
  "userland-proxy": false,
  "experimental": false,
  "metrics-addr": "127.0.0.1:9323",
  "default-address-pools": [
    {
      "base": "172.17.0.0/12",
      "size": 24
    }
  ]
}
EOF

# Restart Docker
sudo systemctl restart docker
```

### 2. Docker Compose Installation

#### Install Docker Compose
```bash
# Install Docker Compose (already included with docker-compose-plugin)
# Verify installation
docker compose version

# Create application directory
mkdir -p /home/chitlaq/chitlaq-mvp
cd /home/chitlaq/chitlaq-mvp
```

## Infrastructure Deployment

### 1. Clone Repository

#### Get Application Code
```bash
# Clone repository (replace with actual repository URL)
git clone https://github.com/your-org/chitlaq-mvp.git .

# Set proper permissions
sudo chown -R chitlaq:chitlaq /home/chitlaq/chitlaq-mvp
```

### 2. Environment Configuration

#### Create Environment Files
```bash
# Copy environment template
cp env.example .env

# Edit environment configuration
nano .env

# Set required variables:
# - Database credentials
# - Redis configuration
# - JWT secrets
# - API keys
# - Domain configuration
```

#### Environment Variables Setup
```bash
# Generate secure secrets
openssl rand -hex 32  # For JWT secret
openssl rand -hex 32  # For database password
openssl rand -hex 32  # For Redis password

# Set environment variables
export POSTGRES_PASSWORD=$(openssl rand -hex 32)
export REDIS_PASSWORD=$(openssl rand -hex 32)
export JWT_SECRET=$(openssl rand -hex 32)
export SUPABASE_ANON_KEY=$(openssl rand -hex 32)
export SUPABASE_SERVICE_ROLE_KEY=$(openssl rand -hex 32)
```

### 3. Infrastructure Deployment

#### Deploy Infrastructure Stack
```bash
# Start infrastructure services
docker compose up -d

# Check service status
docker compose ps

# View logs
docker compose logs -f
```

#### Verify Services
```bash
# Check if all services are running
docker compose ps

# Test database connection
docker compose exec postgres psql -U postgres -c "SELECT version();"

# Test Redis connection
docker compose exec redis redis-cli ping

# Test Nginx
curl -I http://localhost
```

## Service Configuration

### 1. Database Configuration

#### PostgreSQL Setup
```bash
# Connect to PostgreSQL
docker compose exec postgres psql -U postgres

# Create database
CREATE DATABASE chitlaq;

# Create user
CREATE USER chitlaq_user WITH PASSWORD 'your_password';

# Grant privileges
GRANT ALL PRIVILEGES ON DATABASE chitlaq TO chitlaq_user;

# Exit PostgreSQL
\q
```

#### Run Database Migrations
```bash
# Run initial migrations
docker compose exec api npm run migrate

# Verify tables
docker compose exec postgres psql -U postgres -d chitlaq -c "\dt"
```

### 2. Redis Configuration

#### Redis Setup
```bash
# Connect to Redis
docker compose exec redis redis-cli

# Test Redis
PING

# Set test key
SET test "Hello Redis"

# Get test key
GET test

# Exit Redis
EXIT
```

### 3. Application Services

#### API Gateway Configuration
```bash
# Check API Gateway logs
docker compose logs api-gateway

# Test API endpoint
curl http://localhost:3001/health

# Test authentication
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@university.edu","password":"TestPass123!"}'
```

#### WebSocket Service Configuration
```bash
# Check WebSocket logs
docker compose logs websocket

# Test WebSocket connection
wscat -c ws://localhost:3002/ws
```

## SSL/TLS Setup

### 1. Domain Configuration

#### DNS Setup
```bash
# Configure DNS records
# A record: your-domain.com -> YOUR_SERVER_IP
# A record: www.your-domain.com -> YOUR_SERVER_IP
# A record: api.your-domain.com -> YOUR_SERVER_IP
# A record: ws.your-domain.com -> YOUR_SERVER_IP
```

#### Verify DNS Resolution
```bash
# Test DNS resolution
nslookup your-domain.com
nslookup api.your-domain.com
nslookup ws.your-domain.com
```

### 2. Let's Encrypt Setup

#### Install Certbot
```bash
# Install Certbot
sudo apt install -y certbot python3-certbot-nginx

# Stop Nginx temporarily
docker compose stop nginx
```

#### Generate SSL Certificates
```bash
# Generate certificates
sudo certbot certonly --standalone \
  -d your-domain.com \
  -d www.your-domain.com \
  -d api.your-domain.com \
  -d ws.your-domain.com \
  --email your-email@example.com \
  --agree-tos \
  --non-interactive
```

#### Configure Auto-renewal
```bash
# Test auto-renewal
sudo certbot renew --dry-run

# Add to crontab
sudo crontab -e

# Add this line:
# 0 12 * * * /usr/bin/certbot renew --quiet
```

### 3. Nginx SSL Configuration

#### Update Nginx Configuration
```bash
# Update Nginx configuration for SSL
# The configuration should already include SSL settings
# Verify SSL configuration
docker compose exec nginx nginx -t

# Restart Nginx
docker compose restart nginx
```

#### Test SSL Configuration
```bash
# Test SSL
curl -I https://your-domain.com

# Test SSL with OpenSSL
openssl s_client -connect your-domain.com:443 -servername your-domain.com
```

## Security Hardening

### 1. System Security

#### Install Security Tools
```bash
# Install Fail2ban
sudo apt install -y fail2ban

# Configure Fail2ban
sudo tee /etc/fail2ban/jail.local << EOF
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
maxretry = 3

[nginx-http-auth]
enabled = true
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3
EOF

# Start Fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

#### Configure Audit Logging
```bash
# Install Auditd
sudo apt install -y auditd audispd-plugins

# Configure audit rules
sudo tee /etc/audit/rules.d/chitlaq.rules << EOF
# Monitor file access
-w /etc/passwd -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/shadow -p wa -k identity

# Monitor system calls
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change

# Monitor network configuration
-w /etc/network/ -p wa -k network-config
-w /etc/hosts -p wa -k network-config
EOF

# Restart auditd
sudo systemctl restart auditd
```

### 2. Application Security

#### Container Security
```bash
# Run containers as non-root user
# Update docker-compose.yml to include:
# user: "1000:1000"

# Scan for vulnerabilities
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image chitlaq-mvp-api:latest
```

#### Network Security
```bash
# Configure Docker network security
# Create custom network
docker network create --driver bridge \
  --subnet=172.20.0.0/16 \
  --opt com.docker.network.bridge.name=chitlaq-br0 \
  chitlaq-network

# Update docker-compose.yml to use custom network
```

## Monitoring Setup

### 1. Prometheus Configuration

#### Verify Prometheus
```bash
# Check Prometheus status
docker compose logs prometheus

# Access Prometheus UI
curl http://localhost:9090

# Check targets
curl http://localhost:9090/api/v1/targets
```

### 2. Grafana Configuration

#### Setup Grafana
```bash
# Access Grafana
curl http://localhost:3000

# Default credentials: admin/admin
# Change default password on first login

# Import dashboards
# - System Overview Dashboard
# - Database Performance Dashboard
# - Application Metrics Dashboard
```

### 3. Alerting Configuration

#### Configure Alertmanager
```bash
# Check Alertmanager status
docker compose logs alertmanager

# Access Alertmanager UI
curl http://localhost:9093

# Test alerting
curl -X POST http://localhost:9093/api/v1/alerts \
  -H "Content-Type: application/json" \
  -d '[{"labels":{"alertname":"TestAlert"}}]'
```

## Backup Configuration

### 1. Database Backup

#### Configure Automated Backups
```bash
# Create backup directory
sudo mkdir -p /opt/backups/chitlaq
sudo chown chitlaq:chitlaq /opt/backups/chitlaq

# Test backup script
./backup-scripts/backup.sh

# Add to crontab
crontab -e

# Add backup schedule:
# 0 2 * * * /home/chitlaq/chitlaq-mvp/backup-scripts/backup.sh
```

#### Test Backup Restoration
```bash
# Test backup restoration
./backup-scripts/restore.sh /opt/backups/chitlaq/backup_YYYYMMDD_HHMMSS.sql
```

### 2. Configuration Backup

#### Backup Configuration Files
```bash
# Create configuration backup
tar -czf /opt/backups/chitlaq/config_$(date +%Y%m%d_%H%M%S).tar.gz \
  docker-compose.yml \
  .env \
  nginx/ \
  monitoring/ \
  scripts/

# Schedule configuration backup
# 0 3 * * 0 /home/chitlaq/chitlaq-mvp/scripts/backup-config.sh
```

## Verification and Testing

### 1. Health Checks

#### System Health
```bash
# Check system resources
htop
df -h
free -h
iostat 1 5

# Check Docker resources
docker system df
docker stats --no-stream
```

#### Service Health
```bash
# Run health check script
./scripts/health-check.sh

# Check individual services
curl http://localhost:3001/health
curl http://localhost:3002/health
curl http://localhost:3003/health
curl http://localhost:3004/health
curl http://localhost:3005/health
```

### 2. Performance Testing

#### Load Testing
```bash
# Run basic load test
./scripts/benchmark.sh --url https://your-domain.com --concurrent 10 --duration 60s

# Check performance metrics
curl http://localhost:9090/api/v1/query?query=up
```

### 3. Security Testing

#### Security Scan
```bash
# Run security scan
nmap -sS -O localhost

# Check SSL configuration
sslscan your-domain.com

# Test firewall
nmap -p 1-65535 your-domain.com
```

## Troubleshooting

### 1. Common Issues

#### Service Won't Start
```bash
# Check service logs
docker compose logs SERVICE_NAME

# Check service status
docker compose ps

# Restart service
docker compose restart SERVICE_NAME
```

#### Database Connection Issues
```bash
# Check database logs
docker compose logs postgres

# Test database connection
docker compose exec postgres psql -U postgres -c "SELECT 1;"

# Check database configuration
docker compose exec postgres cat /var/lib/postgresql/data/postgresql.conf
```

#### SSL Certificate Issues
```bash
# Check certificate status
sudo certbot certificates

# Renew certificates
sudo certbot renew

# Check Nginx SSL configuration
docker compose exec nginx nginx -t
```

### 2. Performance Issues

#### High CPU Usage
```bash
# Check top processes
top -c

# Check Docker stats
docker stats

# Check system load
uptime
```

#### High Memory Usage
```bash
# Check memory usage
free -h
cat /proc/meminfo

# Check Docker memory usage
docker stats --no-stream
```

#### Disk Space Issues
```bash
# Check disk usage
df -h
du -sh /var/lib/docker

# Clean up Docker
docker system prune -a
```

### 3. Network Issues

#### Connection Timeouts
```bash
# Check network connectivity
ping google.com
telnet your-domain.com 443

# Check firewall rules
sudo ufw status
sudo iptables -L
```

#### DNS Issues
```bash
# Check DNS resolution
nslookup your-domain.com
dig your-domain.com

# Check DNS configuration
cat /etc/resolv.conf
```

## Maintenance Procedures

### 1. Regular Maintenance

#### Daily Tasks
```bash
# Check service status
docker compose ps

# Check disk space
df -h

# Check system load
uptime

# Review logs for errors
docker compose logs --tail=100
```

#### Weekly Tasks
```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Clean up Docker
docker system prune -f

# Check backup status
ls -la /opt/backups/chitlaq/

# Review security logs
sudo journalctl -u fail2ban
```

#### Monthly Tasks
```bash
# Security audit
sudo apt audit

# Performance review
./scripts/benchmark.sh

# Capacity planning review
df -h
free -h
```

### 2. Update Procedures

#### Application Updates
```bash
# Pull latest code
git pull origin main

# Rebuild and restart services
docker compose down
docker compose build
docker compose up -d

# Run database migrations
docker compose exec api npm run migrate
```

#### System Updates
```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Reboot if kernel updated
sudo reboot
```

## Conclusion

This infrastructure setup guide provides comprehensive instructions for deploying the ChitLaq M1 MVP infrastructure. Following these procedures will result in a secure, scalable, and maintainable infrastructure that meets all performance and security requirements.

Key success factors:
1. **Follow the guide step-by-step** without skipping any sections
2. **Verify each step** before proceeding to the next
3. **Test all functionality** after deployment
4. **Implement monitoring** and alerting immediately
5. **Schedule regular maintenance** and updates

The infrastructure is now ready for application deployment and production use.

---

**Document Version**: 1.0  
**Last Updated**: 2024  
**Next Review**: Monthly  
**Maintained by**: ChitLaq Infrastructure Team
