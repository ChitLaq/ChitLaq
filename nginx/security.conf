# ChitLaq M1 MVP - Nginx Security Configuration
# Production-grade security headers and policies
# Generated by PROMPT 1.2 - Security Configuration Setup

# Hide Nginx version and server tokens
server_tokens off;
more_clear_headers Server;
more_set_headers "Server: ChitLaq";

# Security Headers Configuration
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header X-Permitted-Cross-Domain-Policies "none" always;
add_header X-Download-Options "noopen" always;

# Strict Transport Security (HSTS)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Content Security Policy (CSP)
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' 
        https://www.googletagmanager.com 
        https://www.google-analytics.com 
        https://pagead2.googlesyndication.com 
        https://tpc.googlesyndication.com;
    style-src 'self' 'unsafe-inline' 
        https://fonts.googleapis.com 
        https://pagead2.googlesyndication.com;
    img-src 'self' data: blob: https: 
        https://www.google-analytics.com 
        https://pagead2.googlesyndication.com 
        https://tpc.googlesyndication.com;
    font-src 'self' 
        https://fonts.gstatic.com;
    connect-src 'self' wss: https: 
        https://www.google-analytics.com;
    media-src 'self' blob: data:;
    object-src 'none';
    child-src 'self' 
        https://pagead2.googlesyndication.com 
        https://tpc.googlesyndication.com;
    frame-src 'self' 
        https://pagead2.googlesyndication.com 
        https://tpc.googlesyndication.com;
    worker-src 'self' blob:;
    manifest-src 'self';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
" always;

# Permissions Policy (Feature Policy)
add_header Permissions-Policy "
    accelerometer=(),
    autoplay=(self),
    camera=(),
    clipboard-read=(self),
    clipboard-write=(self),
    cross-origin-isolated=(),
    display-capture=(),
    document-domain=(self),
    encrypted-media=(),
    fullscreen=(self),
    geolocation=(),
    gyroscope=(),
    keyboard-map=(),
    magnetometer=(),
    microphone=(),
    midi=(),
    payment=(),
    picture-in-picture=(self),
    publickey-credentials-get=(),
    screen-wake-lock=(),
    sync-xhr=(self),
    usb=(),
    web-share=(self),
    xr-spatial-tracking=()
" always;

# MIME Type Security
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf|webp|avif)$ {
    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Cache control for static assets
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    
    # Security headers for static assets
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # CORS for fonts and assets
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin '*' always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
        add_header Access-Control-Max-Age 1728000 always;
        add_header Content-Type 'text/plain; charset=utf-8' always;
        add_header Content-Length 0 always;
        return 204;
    }
}

# Block access to sensitive files
location ~* \.(htaccess|htpasswd|ini|log|sh|sql|conf|bak|backup|swp|tmp)$ {
    deny all;
    return 404;
}

# Block access to hidden files
location ~ /\. {
    deny all;
    return 404;
}

# Block access to backup files
location ~* ~$ {
    deny all;
    return 404;
}

# Block access to version control directories
location ~ /\.(git|svn|hg|bzr) {
    deny all;
    return 404;
}

# Block access to common exploit paths
location ~* /(wp-admin|wp-content|wp-includes|admin|phpMyAdmin|phpmyadmin|pma|mysql|admin.php|configuration.php) {
    deny all;
    return 404;
}

# Block common vulnerability scanners
location ~* /(\.well-known/security\.txt|security\.txt|\.well-known/apple-app-site-association) {
    return 404;
}

# Rate limiting configuration
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=upload:10m rate=2r/s;
limit_req_zone $binary_remote_addr zone=search:10m rate=8r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=15r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn_zone $server_name zone=conn_limit_per_server:10m;

# Request size limits
client_max_body_size 50M;
client_body_buffer_size 128k;
client_header_buffer_size 1k;
large_client_header_buffers 4 8k;

# Timeouts to prevent slowloris attacks
client_body_timeout 12;
client_header_timeout 12;
keepalive_timeout 15;
send_timeout 10;

# Prevent click-jacking
add_header X-Frame-Options "SAMEORIGIN" always;

# Prevent MIME type confusion
add_header X-Content-Type-Options "nosniff" always;

# XSS Protection
add_header X-XSS-Protection "1; mode=block" always;

# Referrer Policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# DNS Prefetch Control
add_header X-DNS-Prefetch-Control "off" always;

# Remove potentially dangerous headers
more_clear_headers "X-Powered-By";
more_clear_headers "X-AspNet-Version";
more_clear_headers "X-AspNetMvc-Version";

# Security-focused proxy headers
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-Host $host;
proxy_set_header X-Forwarded-Port $server_port;

# Buffer security settings
proxy_buffer_size 4k;
proxy_buffers 8 4k;
proxy_busy_buffers_size 8k;
proxy_temp_file_write_size 8k;

# Proxy timeouts
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;

# Hide upstream errors
proxy_intercept_errors on;
error_page 500 502 503 504 /50x.html;

# Custom error pages
error_page 400 /errors/400.html;
error_page 401 /errors/401.html;
error_page 403 /errors/403.html;
error_page 404 /errors/404.html;
error_page 429 /errors/429.html;
error_page 500 /errors/500.html;
error_page 502 /errors/502.html;
error_page 503 /errors/503.html;
error_page 504 /errors/504.html;

# Gzip security settings
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_min_length 1000;
gzip_disable "msie6";

# SSL security (when SSL is enabled)
ssl_protocols TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers off;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;

# Session security
ssl_session_timeout 1d;
ssl_session_cache shared:SSL:50m;
ssl_session_tickets off;

# OCSP stapling
ssl_stapling on;
ssl_stapling_verify on;

# DNS resolver for OCSP
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

# Security headers for API endpoints
location /api/ {
    # Rate limiting for API
    limit_req zone=api burst=20 nodelay;
    limit_conn conn_limit_per_ip 10;
    
    # API specific headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # CORS for API
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin 'https://chitlaq.com' always;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,ApiKey' always;
        add_header Access-Control-Allow-Credentials 'true' always;
        add_header Access-Control-Max-Age 1728000 always;
        add_header Content-Type 'text/plain; charset=utf-8' always;
        add_header Content-Length 0 always;
        return 204;
    }
    
    # API CORS for actual requests
    add_header Access-Control-Allow-Origin 'https://chitlaq.com' always;
    add_header Access-Control-Allow-Credentials 'true' always;
    add_header Access-Control-Expose-Headers 'Content-Length,Content-Range,X-Total-Count' always;
}

# Security headers for auth endpoints
location /auth/ {
    # Stricter rate limiting for auth
    limit_req zone=auth burst=10 nodelay;
    limit_conn conn_limit_per_ip 5;
    
    # Auth specific headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}

# Security for upload endpoints
location /storage/ {
    # Rate limiting for uploads
    limit_req zone=upload burst=5 nodelay;
    limit_conn conn_limit_per_ip 3;
    
    # Upload specific limits
    client_max_body_size 50M;
    client_body_timeout 60s;
    
    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    
    # Virus scanning header (if implemented)
    add_header X-Virus-Scanned "by ChitLaq Security" always;
}

# Security for WebSocket connections
location /realtime/ {
    # WebSocket security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    
    # Connection limits for WebSocket
    limit_conn conn_limit_per_ip 20;
    
    # WebSocket timeout settings
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
}

# Security for admin areas
location ~ ^/(admin|grafana|studio)/ {
    # Restrict admin access by IP if configured
    # allow 127.0.0.1;
    # allow YOUR_OFFICE_IP;
    # deny all;
    
    # Additional security headers for admin
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    
    # Basic auth for additional security layer
    # auth_basic "ChitLaq Admin Area";
    # auth_basic_user_file /etc/nginx/.htpasswd;
}

# Bot protection
map $http_user_agent $limit_bots {
    default 0;
    ~*(googlebot|bingbot|yandex|baiduspider) 0;
    ~*(ahrefs|semrush|majestic|moz|serpstat) 1;
    ~*(bot|crawler|spider|scraper) 1;
}

# IP reputation (customize with your preferred service)
# geo $bad_ip {
#     default 0;
#     include /etc/nginx/conf.d/blacklist.conf;
# }

# Security monitoring
log_format security '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '$request_time $upstream_response_time '
                   '"$http_x_forwarded_for" "$http_authorization" '
                   '"$sent_http_x_frame_options"';

# Log security events
access_log /var/log/nginx/security.log security;

# Additional security map for request blocking
map $request_uri $block_request {
    default 0;
    ~*/\.(git|svn|hg|bzr)/ 1;
    ~*/\.(env|conf|config|bak|backup|swp|tmp)$ 1;
    ~*/(wp-admin|wp-content|wp-includes|admin|phpmyadmin) 1;
    ~*/eval\( 1;
    ~*/union.*select 1;
    ~*/concat\( 1;
    ~*/script.*alert 1;
}

# Block malicious requests
if ($block_request = 1) {
    return 444;
}

# Block requests with no user agent
if ($http_user_agent = "") {
    return 444;
}

# Block specific attack patterns
if ($request_uri ~* "(\<|%3C).*script.*(\>|%3E)") {
    return 444;
}

if ($query_string ~* "[;'\"<>]") {
    return 444;
}

# Rate limiting for bots
if ($limit_bots = 1) {
    set $limit_rate 10k;
}

# DDoS protection headers
add_header X-Rate-Limit "Enabled" always;
add_header X-Security-Scanner "ChitLaq-Guardian" always;
