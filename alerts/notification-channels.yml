# ChitLaq M1 MVP - Notification Channels Configuration
# Generated by PROMPT 1.4 - Monitoring & Observability Stack
# Senior SRE - 15+ years monitoring and incident response experience

# Alertmanager notification channels configuration
# This file defines all notification channels for different alert severities

global:
  # Global SMTP configuration for email notifications
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@chitlaq.com'
  smtp_auth_username: 'alerts@chitlaq.com'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true
  
  # Global Slack configuration
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  
  # Global PagerDuty configuration
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

# Notification templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route configuration - defines how alerts are routed to different channels
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default-receiver'
  routes:
    # Critical alerts (P0) - Immediate notification
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 5m
      routes:
        # Database down - Page immediately
        - match:
            alertname: DatabaseDown
          receiver: 'database-critical'
          group_wait: 0s
          repeat_interval: 2m
        # API completely down - Page immediately
        - match:
            alertname: APIDown
          receiver: 'api-critical'
          group_wait: 0s
          repeat_interval: 2m
        # Security breach - Page immediately
        - match:
            alertname: SecurityBreach
          receiver: 'security-critical'
          group_wait: 0s
          repeat_interval: 1m
        # Disk space critical - Page immediately
        - match:
            alertname: DiskSpaceCritical
          receiver: 'infrastructure-critical'
          group_wait: 0s
          repeat_interval: 2m
    
    # Warning alerts (P1) - 15 minute response
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 15m
      routes:
        # High error rate - Notify team
        - match:
            alertname: HighErrorRate
          receiver: 'application-warning'
        # Slow response times - Notify team
        - match:
            alertname: SlowResponseTime
          receiver: 'performance-warning'
        # Memory usage high - Notify team
        - match:
            alertname: HighMemoryUsage
          receiver: 'infrastructure-warning'
        # Failed login attempts - Notify security
        - match:
            alertname: FailedLoginSpike
          receiver: 'security-warning'
    
    # Info alerts (P2) - 1 hour response
    - match:
        severity: info
      receiver: 'info-alerts'
      group_wait: 2m
      repeat_interval: 1h
      routes:
        # Service restart - Log only
        - match:
            alertname: ServiceRestart
          receiver: 'maintenance-info'
        # Configuration change - Log only
        - match:
            alertname: ConfigChange
          receiver: 'maintenance-info'
        # Maintenance window - Log only
        - match:
            alertname: MaintenanceWindow
          receiver: 'maintenance-info'

# Inhibit rules - prevent duplicate alerts
inhibit_rules:
  # Don't alert on individual instances if the entire service is down
  - source_match:
      severity: 'critical'
      alertname: 'ServiceDown'
    target_match:
      severity: 'warning'
    equal: ['service', 'cluster']
  
  # Don't alert on high memory if the instance is down
  - source_match:
      severity: 'critical'
      alertname: 'InstanceDown'
    target_match:
      severity: 'warning'
    equal: ['instance']

# Receiver definitions
receivers:
  # Default receiver for unmatched alerts
  - name: 'default-receiver'
    slack_configs:
      - channel: '#alerts'
        title: 'ChitLaq Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        send_resolved: true

  # Critical alerts receiver - PagerDuty + Slack + Email
  - name: 'critical-alerts'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        description: '{{ .GroupLabels.alertname }}: {{ .GroupLabels.service }}'
        details:
          summary: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
          severity: 'critical'
          service: '{{ .GroupLabels.service }}'
          cluster: '{{ .GroupLabels.cluster }}'
    slack_configs:
      - channel: '#critical-alerts'
        title: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          *Service:* {{ .GroupLabels.service }}
          *Cluster:* {{ .GroupLabels.cluster }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'danger'
        send_resolved: true
    email_configs:
      - to: 'critical@chitlaq.com'
        subject: 'üö® CRITICAL ALERT: {{ .GroupLabels.alertname }}'
        body: |
          Critical alert detected in ChitLaq M1 MVP:
          
          Service: {{ .GroupLabels.service }}
          Cluster: {{ .GroupLabels.cluster }}
          Alert: {{ .GroupLabels.alertname }}
          
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Please investigate immediately.
        send_resolved: true

  # Database critical alerts
  - name: 'database-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_DATABASE_KEY}'
        description: 'Database Critical Alert: {{ .GroupLabels.alertname }}'
        details:
          summary: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
          severity: 'critical'
          component: 'database'
    slack_configs:
      - channel: '#database-alerts'
        title: 'üóÑÔ∏è DATABASE CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          *Database Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'danger'
        send_resolved: true
    email_configs:
      - to: 'dba@chitlaq.com'
        subject: 'üóÑÔ∏è DATABASE CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          Database critical alert:
          
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Immediate attention required.
        send_resolved: true

  # API critical alerts
  - name: 'api-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_API_KEY}'
        description: 'API Critical Alert: {{ .GroupLabels.alertname }}'
        details:
          summary: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
          severity: 'critical'
          component: 'api'
    slack_configs:
      - channel: '#api-alerts'
        title: 'üîå API CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          *API Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'danger'
        send_resolved: true
    email_configs:
      - to: 'api-team@chitlaq.com'
        subject: 'üîå API CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          API critical alert:
          
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Immediate attention required.
        send_resolved: true

  # Security critical alerts
  - name: 'security-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SECURITY_KEY}'
        description: 'Security Critical Alert: {{ .GroupLabels.alertname }}'
        details:
          summary: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
          severity: 'critical'
          component: 'security'
    slack_configs:
      - channel: '#security-alerts'
        title: 'üîí SECURITY CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          *Security Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'danger'
        send_resolved: true
    email_configs:
      - to: 'security@chitlaq.com'
        subject: 'üîí SECURITY CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          Security critical alert:
          
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Immediate attention required.
        send_resolved: true

  # Infrastructure critical alerts
  - name: 'infrastructure-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_INFRASTRUCTURE_KEY}'
        description: 'Infrastructure Critical Alert: {{ .GroupLabels.alertname }}'
        details:
          summary: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
          severity: 'critical'
          component: 'infrastructure'
    slack_configs:
      - channel: '#infrastructure-alerts'
        title: 'üñ•Ô∏è INFRASTRUCTURE CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          *Infrastructure Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'danger'
        send_resolved: true
    email_configs:
      - to: 'infrastructure@chitlaq.com'
        subject: 'üñ•Ô∏è INFRASTRUCTURE CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          Infrastructure critical alert:
          
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Immediate attention required.
        send_resolved: true

  # Warning alerts receiver - Slack + Email
  - name: 'warning-alerts'
    slack_configs:
      - channel: '#warnings'
        title: '‚ö†Ô∏è WARNING: {{ .GroupLabels.alertname }}'
        text: |
          *Service:* {{ .GroupLabels.service }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'warning'
        send_resolved: true
    email_configs:
      - to: 'warnings@chitlaq.com'
        subject: '‚ö†Ô∏è WARNING: {{ .GroupLabels.alertname }}'
        body: |
          Warning alert in ChitLaq M1 MVP:
          
          Service: {{ .GroupLabels.service }}
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Please investigate within 15 minutes.
        send_resolved: true

  # Application warning alerts
  - name: 'application-warning'
    slack_configs:
      - channel: '#application-alerts'
        title: 'üì± APPLICATION WARNING: {{ .GroupLabels.alertname }}'
        text: |
          *Application Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'warning'
        send_resolved: true
    email_configs:
      - to: 'application-team@chitlaq.com'
        subject: 'üì± APPLICATION WARNING: {{ .GroupLabels.alertname }}'
        body: |
          Application warning alert:
          
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Please investigate within 15 minutes.
        send_resolved: true

  # Performance warning alerts
  - name: 'performance-warning'
    slack_configs:
      - channel: '#performance-alerts'
        title: '‚ö° PERFORMANCE WARNING: {{ .GroupLabels.alertname }}'
        text: |
          *Performance Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'warning'
        send_resolved: true
    email_configs:
      - to: 'performance-team@chitlaq.com'
        subject: '‚ö° PERFORMANCE WARNING: {{ .GroupLabels.alertname }}'
        body: |
          Performance warning alert:
          
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Please investigate within 15 minutes.
        send_resolved: true

  # Infrastructure warning alerts
  - name: 'infrastructure-warning'
    slack_configs:
      - channel: '#infrastructure-alerts'
        title: 'üñ•Ô∏è INFRASTRUCTURE WARNING: {{ .GroupLabels.alertname }}'
        text: |
          *Infrastructure Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'warning'
        send_resolved: true
    email_configs:
      - to: 'infrastructure@chitlaq.com'
        subject: 'üñ•Ô∏è INFRASTRUCTURE WARNING: {{ .GroupLabels.alertname }}'
        body: |
          Infrastructure warning alert:
          
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Please investigate within 15 minutes.
        send_resolved: true

  # Security warning alerts
  - name: 'security-warning'
    slack_configs:
      - channel: '#security-alerts'
        title: 'üîí SECURITY WARNING: {{ .GroupLabels.alertname }}'
        text: |
          *Security Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'warning'
        send_resolved: true
    email_configs:
      - to: 'security@chitlaq.com'
        subject: 'üîí SECURITY WARNING: {{ .GroupLabels.alertname }}'
        body: |
          Security warning alert:
          
          Alert: {{ .GroupLabels.alertname }}
          Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          
          Please investigate within 15 minutes.
        send_resolved: true

  # Info alerts receiver - Slack only
  - name: 'info-alerts'
    slack_configs:
      - channel: '#alerts'
        title: '‚ÑπÔ∏è INFO: {{ .GroupLabels.alertname }}'
        text: |
          *Service:* {{ .GroupLabels.service }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'good'
        send_resolved: true

  # Maintenance info alerts
  - name: 'maintenance-info'
    slack_configs:
      - channel: '#maintenance'
        title: 'üîß MAINTENANCE: {{ .GroupLabels.alertname }}'
        text: |
          *Maintenance Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'good'
        send_resolved: true

# Time muting configuration
time_intervals:
  # Business hours (9 AM - 5 PM EST, Monday-Friday)
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '17:00'
        weekdays: ['monday:friday']
        months: ['january:december']
        years: ['2024:2030']
  
  # Maintenance windows (2 AM - 4 AM EST, Sunday)
  - name: 'maintenance-window'
    time_intervals:
      - times:
          - start_time: '02:00'
            end_time: '04:00'
        weekdays: ['sunday']
        months: ['january:december']
        years: ['2024:2030']
  
  # Off-hours (5 PM - 9 AM EST, Monday-Friday + Weekends)
  - name: 'off-hours'
    time_intervals:
      - times:
          - start_time: '17:00'
            end_time: '23:59'
        weekdays: ['monday:friday']
        months: ['january:december']
        years: ['2024:2030']
      - times:
          - start_time: '00:00'
            end_time: '09:00'
        weekdays: ['monday:friday']
        months: ['january:december']
        years: ['2024:2030']
      - weekdays: ['saturday:sunday']
        months: ['january:december']
        years: ['2024:2030']

# Mute configuration for different time periods
mute_time_intervals:
  # Mute non-critical alerts during maintenance windows
  - name: 'mute-maintenance'
    time_intervals: ['maintenance-window']
    matchers:
      - severity: 'info'
      - alertname: 'ServiceRestart'
  
  # Mute info alerts during off-hours
  - name: 'mute-off-hours'
    time_intervals: ['off-hours']
    matchers:
      - severity: 'info'
