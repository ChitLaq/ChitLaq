# ChitLaq M1 MVP - Common Issues Troubleshooting Guide

> **Generated by PROMPT 1.7** - Infrastructure Documentation & Knowledge Transfer  
> **Senior Technical Writer & Infrastructure Architect** - 15+ years system documentation and knowledge transfer experience

## Executive Summary

This troubleshooting guide provides comprehensive solutions for common issues encountered in the ChitLaq M1 MVP infrastructure. It serves as a quick reference for operations team members to diagnose and resolve problems efficiently, minimizing downtime and maintaining system reliability.

## Table of Contents
- [Database Issues](#database-issues)
- [Application Issues](#application-issues)
- [Infrastructure Issues](#infrastructure-issues)
- [Network Issues](#network-issues)
- [Security Issues](#security-issues)
- [Performance Issues](#performance-issues)
- [Monitoring Issues](#monitoring-issues)
- [Deployment Issues](#deployment-issues)

## Database Issues

### Connection Issues

#### Problem: Database Connection Failed
**Symptoms:**
- API errors: "database connection failed"
- High error rates in logs
- Application timeouts

**Diagnosis:**
```bash
# Check database status
docker compose exec postgres pg_isready -U postgres

# Check database connections
docker compose exec postgres psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"

# Check connection pool
docker compose exec postgres psql -U postgres -c "SHOW max_connections;"
```

**Solutions:**
```bash
# 1. Restart database service
docker compose restart postgres

# 2. Check connection pool settings
docker compose exec postgres psql -U postgres -c "SHOW max_connections;"
docker compose exec postgres psql -U postgres -c "SHOW shared_preload_libraries;"

# 3. Verify database credentials
docker compose exec postgres psql -U postgres -c "SELECT current_user;"

# 4. Check database logs
docker compose logs postgres --tail=50
```

#### Problem: Database Performance Issues
**Symptoms:**
- Slow API response times
- High database CPU usage
- Query timeouts

**Diagnosis:**
```bash
# Check slow queries
docker compose exec postgres psql -U postgres -c "SELECT query, mean_time, calls FROM pg_stat_statements WHERE mean_time > 1000 ORDER BY mean_time DESC LIMIT 10;"

# Check database connections
docker compose exec postgres psql -U postgres -c "SELECT count(*) FROM pg_stat_activity WHERE state = 'active';"

# Check database locks
docker compose exec postgres psql -U postgres -c "SELECT * FROM pg_locks WHERE NOT granted;"
```

**Solutions:**
```bash
# 1. Optimize slow queries
docker compose exec postgres psql -U postgres -c "EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';"

# 2. Add missing indexes
docker compose exec postgres psql -U postgres -c "CREATE INDEX CONCURRENTLY idx_users_email ON users(email);"

# 3. Adjust connection pool settings
# Edit docker-compose.yml
# Increase max_connections or adjust pool size

# 4. Restart database with optimized settings
docker compose restart postgres
```

### Data Issues

#### Problem: Data Corruption
**Symptoms:**
- Inconsistent data
- Integrity constraint violations
- Application errors

**Diagnosis:**
```bash
# Check database integrity
docker compose exec postgres psql -U postgres -c "SELECT * FROM pg_stat_database WHERE datname = 'chitlaq';"

# Check for corrupted tables
docker compose exec postgres psql -U postgres -c "SELECT schemaname, tablename, n_tup_ins, n_tup_upd, n_tup_del FROM pg_stat_user_tables;"
```

**Solutions:**
```bash
# 1. Restore from backup
./scripts/restore-database.sh /opt/backups/chitlaq/full/latest.gz

# 2. Repair corrupted data
docker compose exec postgres psql -U postgres -c "REINDEX DATABASE chitlaq;"

# 3. Check and fix constraints
docker compose exec postgres psql -U postgres -c "SELECT conname, conrelid::regclass, confrelid::regclass FROM pg_constraint WHERE contype = 'f';"
```

## Application Issues

### API Issues

#### Problem: API Gateway Errors
**Symptoms:**
- 502/503 errors
- High response times
- Service unavailable

**Diagnosis:**
```bash
# Check API Gateway health
curl -s http://localhost:3001/health | jq .

# Check API Gateway logs
docker compose logs api-gateway --tail=50

# Check upstream services
curl -s http://localhost:3002/health | jq .
curl -s http://localhost:3003/health | jq .
```

**Solutions:**
```bash
# 1. Restart API Gateway
docker compose restart api-gateway

# 2. Check upstream services
docker compose ps

# 3. Verify load balancer configuration
cat nginx/nginx.conf | grep -A 10 "upstream"

# 4. Check API Gateway configuration
docker compose exec api-gateway cat /app/config.js
```

#### Problem: Authentication Issues
**Symptoms:**
- Login failures
- Session management issues
- Unauthorized access

**Diagnosis:**
```bash
# Check auth service health
curl -s http://localhost:3005/health | jq .

# Check auth service logs
docker compose logs auth-service --tail=50

# Check JWT configuration
docker compose exec auth-service cat /app/config.js
```

**Solutions:**
```bash
# 1. Restart auth service
docker compose restart auth-service

# 2. Check JWT secrets
docker compose exec auth-service cat /app/.env | grep JWT

# 3. Verify database connectivity
docker compose exec postgres psql -U postgres -c "SELECT count(*) FROM users;"

# 4. Check session storage
docker compose exec redis redis-cli keys "session:*"
```

### WebSocket Issues

#### Problem: WebSocket Connection Failures
**Symptoms:**
- Connection failures
- Message delivery issues
- High disconnection rates

**Diagnosis:**
```bash
# Check WebSocket service health
curl -s http://localhost:3002/health | jq .

# Check WebSocket logs
docker compose logs websocket --tail=50

# Check WebSocket connections
curl -s "http://localhost:9090/api/v1/query?query=websocket_connections_active" | jq .
```

**Solutions:**
```bash
# 1. Restart WebSocket service
docker compose restart websocket

# 2. Check WebSocket configuration
docker compose exec websocket cat /app/config.js

# 3. Verify message queue status
docker compose exec redis redis-cli ping

# 4. Check network connectivity
telnet localhost 3002
```

## Infrastructure Issues

### Docker Issues

#### Problem: Container Failures
**Symptoms:**
- Container exits unexpectedly
- Service unavailability
- Resource exhaustion

**Diagnosis:**
```bash
# Check container status
docker compose ps

# Check container logs
docker compose logs --tail=50

# Check resource usage
docker stats --no-stream

# Check Docker daemon
sudo systemctl status docker
```

**Solutions:**
```bash
# 1. Restart failed containers
docker compose restart

# 2. Check resource limits
docker compose exec SERVICE_NAME cat /proc/meminfo

# 3. Clean up Docker system
docker system prune -f

# 4. Restart Docker daemon
sudo systemctl restart docker
```

#### Problem: Resource Exhaustion
**Symptoms:**
- High CPU usage
- Memory exhaustion
- Disk space issues

**Diagnosis:**
```bash
# Check system resources
htop
free -h
df -h

# Check Docker resource usage
docker stats --no-stream

# Check disk usage
du -sh /var/lib/docker
```

**Solutions:**
```bash
# 1. Optimize resource usage
docker system prune -f
docker volume prune -f

# 2. Adjust resource limits
# Edit docker-compose.yml
# Add memory and CPU limits

# 3. Scale services
docker compose up -d --scale SERVICE_NAME=2

# 4. Monitor resource usage
watch docker stats
```

### VPS Issues

#### Problem: VPS Performance Issues
**Symptoms:**
- High system load
- Slow response times
- Resource exhaustion

**Diagnosis:**
```bash
# Check system load
uptime
cat /proc/loadavg

# Check CPU usage
top -bn1 | grep "Cpu(s)"

# Check memory usage
free -h
cat /proc/meminfo

# Check disk I/O
iostat -x 1 5
```

**Solutions:**
```bash
# 1. Optimize system performance
sudo sysctl -w vm.swappiness=10
sudo sysctl -w vm.dirty_ratio=15

# 2. Check for resource-intensive processes
ps aux --sort=-%cpu | head -10
ps aux --sort=-%mem | head -10

# 3. Restart services
sudo systemctl restart docker
docker compose restart

# 4. Monitor system performance
htop
iotop
```

## Network Issues

### DNS Issues

#### Problem: DNS Resolution Failures
**Symptoms:**
- Domain resolution errors
- Service unavailability
- Network connectivity issues

**Diagnosis:**
```bash
# Check DNS resolution
nslookup your-domain.com
dig your-domain.com

# Check DNS configuration
cat /etc/resolv.conf

# Check network connectivity
ping -c 3 google.com
ping -c 3 your-domain.com
```

**Solutions:**
```bash
# 1. Update DNS configuration
echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf

# 2. Restart network services
sudo systemctl restart systemd-resolved

# 3. Check DNS provider status
# Contact DNS provider if issues persist

# 4. Verify domain configuration
dig your-domain.com A
dig your-domain.com AAAA
```

### SSL/TLS Issues

#### Problem: SSL Certificate Issues
**Symptoms:**
- SSL certificate errors
- HTTPS connection failures
- Certificate expiry warnings

**Diagnosis:**
```bash
# Check SSL certificate
openssl s_client -connect your-domain.com:443 -servername your-domain.com

# Check certificate expiry
curl -s "http://localhost:9090/api/v1/query?query=ssl_certificate_expiry_seconds" | jq .

# Check Nginx SSL configuration
cat nginx/nginx.conf | grep -A 10 "ssl_certificate"
```

**Solutions:**
```bash
# 1. Renew SSL certificate
sudo certbot renew --dry-run
sudo certbot renew

# 2. Restart Nginx
sudo systemctl restart nginx

# 3. Check certificate installation
sudo certbot certificates

# 4. Verify SSL configuration
curl -I https://your-domain.com
```

## Security Issues

### Authentication Issues

#### Problem: Failed Login Attempts
**Symptoms:**
- High failed login rates
- Account lockouts
- Security alerts

**Diagnosis:**
```bash
# Check authentication logs
sudo journalctl -u ssh --since "24 hours ago" | grep -i "failed\|invalid"

# Check Fail2ban status
sudo fail2ban-client status

# Check banned IPs
sudo fail2ban-client status sshd
```

**Solutions:**
```bash
# 1. Review authentication logs
sudo journalctl -u ssh --since "24 hours ago" | tail -20

# 2. Check Fail2ban configuration
sudo fail2ban-client status

# 3. Unban legitimate IPs if needed
sudo fail2ban-client set sshd unbanip IP_ADDRESS

# 4. Update security policies
sudo fail2ban-client reload
```

### Firewall Issues

#### Problem: Firewall Blocking Legitimate Traffic
**Symptoms:**
- Service unavailability
- Connection timeouts
- Network access issues

**Diagnosis:**
```bash
# Check firewall status
sudo iptables -L -n

# Check firewall rules
sudo iptables -L -n -v

# Check blocked connections
sudo journalctl -u ufw --since "24 hours ago"
```

**Solutions:**
```bash
# 1. Check firewall rules
sudo iptables -L -n

# 2. Allow legitimate traffic
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 3. Restart firewall
sudo systemctl restart ufw

# 4. Verify firewall configuration
sudo iptables -L -n
```

## Performance Issues

### API Performance Issues

#### Problem: Slow API Response Times
**Symptoms:**
- High response times
- Timeout errors
- User complaints

**Diagnosis:**
```bash
# Check API response times
curl -s "http://localhost:9090/api/v1/query?query=histogram_quantile(0.95,rate(http_request_duration_seconds_bucket[5m]))" | jq .

# Check API throughput
curl -s "http://localhost:9090/api/v1/query?query=rate(http_requests_total[5m])" | jq .

# Check error rates
curl -s "http://localhost:9090/api/v1/query?query=rate(http_requests_total{status=~'5..'}[5m])" | jq .
```

**Solutions:**
```bash
# 1. Optimize API performance
# Check slow queries
docker compose exec postgres psql -U postgres -c "SELECT query, mean_time, calls FROM pg_stat_statements WHERE mean_time > 1000 ORDER BY mean_time DESC LIMIT 10;"

# 2. Add caching
docker compose exec redis redis-cli FLUSHALL

# 3. Scale services
docker compose up -d --scale api-gateway=2

# 4. Monitor performance
watch curl -s "http://localhost:9090/api/v1/query?query=histogram_quantile(0.95,rate(http_request_duration_seconds_bucket[5m]))" | jq .
```

### Database Performance Issues

#### Problem: Database Slow Queries
**Symptoms:**
- Slow database queries
- High database CPU usage
- Query timeouts

**Diagnosis:**
```bash
# Check slow queries
docker compose exec postgres psql -U postgres -c "SELECT query, mean_time, calls FROM pg_stat_statements WHERE mean_time > 1000 ORDER BY mean_time DESC LIMIT 10;"

# Check database connections
docker compose exec postgres psql -U postgres -c "SELECT count(*) FROM pg_stat_activity WHERE state = 'active';"

# Check database locks
docker compose exec postgres psql -U postgres -c "SELECT * FROM pg_locks WHERE NOT granted;"
```

**Solutions:**
```bash
# 1. Optimize slow queries
docker compose exec postgres psql -U postgres -c "EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';"

# 2. Add missing indexes
docker compose exec postgres psql -U postgres -c "CREATE INDEX CONCURRENTLY idx_users_email ON users(email);"

# 3. Adjust connection pool
# Edit docker-compose.yml
# Increase max_connections

# 4. Monitor database performance
watch docker compose exec postgres psql -U postgres -c "SELECT query, mean_time, calls FROM pg_stat_statements WHERE mean_time > 1000 ORDER BY mean_time DESC LIMIT 5;"
```

## Monitoring Issues

### Prometheus Issues

#### Problem: Prometheus Not Collecting Metrics
**Symptoms:**
- Missing metrics
- Monitoring gaps
- Alert failures

**Diagnosis:**
```bash
# Check Prometheus status
curl -s http://localhost:9090/api/v1/status/config | jq .

# Check Prometheus targets
curl -s http://localhost:9090/api/v1/targets | jq .

# Check Prometheus logs
docker compose logs prometheus --tail=50
```

**Solutions:**
```bash
# 1. Restart Prometheus
docker compose restart prometheus

# 2. Check Prometheus configuration
docker compose exec prometheus cat /etc/prometheus/prometheus.yml

# 3. Verify target endpoints
curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | select(.health != "up")'

# 4. Check Prometheus storage
docker compose exec prometheus ls -la /prometheus/
```

### Grafana Issues

#### Problem: Grafana Dashboard Issues
**Symptoms:**
- Dashboard loading errors
- Missing data
- Visualization problems

**Diagnosis:**
```bash
# Check Grafana status
curl -s http://localhost:3000/api/health | jq .

# Check Grafana logs
docker compose logs grafana --tail=50

# Check Grafana configuration
docker compose exec grafana cat /etc/grafana/grafana.ini
```

**Solutions:**
```bash
# 1. Restart Grafana
docker compose restart grafana

# 2. Check Grafana configuration
docker compose exec grafana cat /etc/grafana/grafana.ini

# 3. Verify Prometheus connection
curl -s http://localhost:3000/api/datasources | jq .

# 4. Check dashboard configuration
docker compose exec grafana ls -la /var/lib/grafana/dashboards/
```

## Deployment Issues

### CI/CD Issues

#### Problem: Deployment Failures
**Symptoms:**
- Build failures
- Deployment errors
- Service unavailability

**Diagnosis:**
```bash
# Check deployment logs
docker compose logs --tail=50

# Check service status
docker compose ps

# Check deployment scripts
./scripts/deploy.sh --dry-run
```

**Solutions:**
```bash
# 1. Check deployment configuration
cat .github/workflows/cd-production.yml

# 2. Verify environment variables
cat .env

# 3. Test deployment locally
docker compose up -d

# 4. Rollback if needed
./scripts/rollback.sh
```

### Environment Issues

#### Problem: Environment Configuration Issues
**Symptoms:**
- Service startup failures
- Configuration errors
- Environment mismatches

**Diagnosis:**
```bash
# Check environment variables
cat .env

# Check service configuration
docker compose config

# Check service logs
docker compose logs --tail=50
```

**Solutions:**
```bash
# 1. Verify environment variables
cat .env | grep -v "^#"

# 2. Check service configuration
docker compose config

# 3. Restart services
docker compose restart

# 4. Verify service health
./scripts/health-check.sh
```

## Conclusion

This troubleshooting guide provides comprehensive solutions for common issues encountered in the ChitLaq M1 MVP infrastructure. Following these procedures ensures efficient problem resolution, minimizes downtime, and maintains system reliability.

Key troubleshooting principles:
1. **Systematic Approach**: Follow diagnosis and solution steps
2. **Documentation**: Record all actions and observations
3. **Verification**: Always verify solutions work
4. **Prevention**: Learn from issues to prevent recurrence
5. **Communication**: Keep stakeholders informed

Regular review and updates of this guide ensure it remains current and effective for troubleshooting operations.

---

**Document Version**: 1.0  
**Last Updated**: 2024  
**Next Review**: Monthly  
**Maintained by**: ChitLaq Operations Team
