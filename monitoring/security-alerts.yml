# ChitLaq M1 MVP - Prometheus Security Alerts Configuration
# Comprehensive security monitoring and alerting rules
# Generated by PROMPT 1.2 - Security Configuration Setup

groups:
  - name: chitlaq.security.rules
    interval: 30s
    rules:
      # High Error Rate Alert
      - alert: HighErrorRate
        expr: (
          sum(rate(nginx_http_requests_total{status=~"5.."}[5m])) by (instance) /
          sum(rate(nginx_http_requests_total[5m])) by (instance)
        ) * 100 > 5
        for: 2m
        labels:
          severity: warning
          service: nginx
          category: security
        annotations:
          summary: "High error rate detected on {{ $labels.instance }}"
          description: "Error rate is {{ $value }}% for the last 5 minutes on {{ $labels.instance }}"
          
      - alert: CriticalErrorRate
        expr: (
          sum(rate(nginx_http_requests_total{status=~"5.."}[5m])) by (instance) /
          sum(rate(nginx_http_requests_total[5m])) by (instance)
        ) * 100 > 15
        for: 1m
        labels:
          severity: critical
          service: nginx
          category: security
        annotations:
          summary: "Critical error rate detected on {{ $labels.instance }}"
          description: "Error rate is {{ $value }}% for the last 5 minutes on {{ $labels.instance }}"

      # Authentication Failure Alerts
      - alert: HighAuthFailureRate
        expr: rate(nginx_http_requests_total{status="401"}[5m]) > 10
        for: 2m
        labels:
          severity: warning
          service: auth
          category: security
        annotations:
          summary: "High authentication failure rate"
          description: "Authentication failures: {{ $value }} per second over the last 5 minutes"
          
      - alert: SuspiciousAuthActivity
        expr: rate(nginx_http_requests_total{status="401"}[1m]) > 50
        for: 30s
        labels:
          severity: critical
          service: auth
          category: security
        annotations:
          summary: "Suspicious authentication activity detected"
          description: "Very high authentication failure rate: {{ $value }} per second"

      # Rate Limiting Alerts
      - alert: RateLimitingTriggered
        expr: rate(nginx_http_requests_total{status="429"}[5m]) > 5
        for: 1m
        labels:
          severity: warning
          service: nginx
          category: security
        annotations:
          summary: "Rate limiting frequently triggered"
          description: "Rate limiting triggered {{ $value }} times per second over the last 5 minutes"

      - alert: MassiveRateLimiting
        expr: rate(nginx_http_requests_total{status="429"}[1m]) > 100
        for: 30s
        labels:
          severity: critical
          service: nginx
          category: security
        annotations:
          summary: "Massive rate limiting - possible DDoS attack"
          description: "Rate limiting triggered {{ $value }} times per second - possible DDoS attack"

      # Database Security Alerts
      - alert: DatabaseConnectionSpike
        expr: increase(postgresql_connections_total[5m]) > 100
        for: 2m
        labels:
          severity: warning
          service: postgresql
          category: security
        annotations:
          summary: "Database connection spike detected"
          description: "Database connections increased by {{ $value }} in the last 5 minutes"

      - alert: DatabaseHighConnections
        expr: postgresql_connections_active > 150
        for: 5m
        labels:
          severity: warning
          service: postgresql
          category: security
        annotations:
          summary: "High number of database connections"
          description: "Active database connections: {{ $value }}"

      - alert: DatabaseConnectionsExhausted
        expr: postgresql_connections_active >= postgresql_connections_max * 0.9
        for: 1m
        labels:
          severity: critical
          service: postgresql
          category: security
        annotations:
          summary: "Database connections nearly exhausted"
          description: "Active connections ({{ $value }}) approaching maximum"

      # Redis Security Alerts
      - alert: RedisHighConnections
        expr: redis_connected_clients > 1000
        for: 5m
        labels:
          severity: warning
          service: redis
          category: security
        annotations:
          summary: "High number of Redis connections"
          description: "Redis connected clients: {{ $value }}"

      - alert: RedisConnectionSpike
        expr: increase(redis_connected_clients[2m]) > 500
        for: 1m
        labels:
          severity: warning
          service: redis
          category: security
        annotations:
          summary: "Redis connection spike detected"
          description: "Redis connections increased by {{ $value }} in 2 minutes"

      # System Security Alerts
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
        for: 5m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% for 5 minutes"

      - alert: CriticalCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
          service: system
          category: security
        annotations:
          summary: "Critical CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% - possible resource exhaustion attack"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value }}%"

      - alert: CriticalMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
          service: system
          category: security
        annotations:
          summary: "Critical memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value }}% - possible memory exhaustion attack"

      # Disk Security Alerts
      - alert: DiskSpaceWarning
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: system
          category: security
        annotations:
          summary: "Disk space warning on {{ $labels.instance }}"
          description: "Disk usage is {{ $value }}% on {{ $labels.mountpoint }}"

      - alert: DiskSpaceCritical
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 95
        for: 1m
        labels:
          severity: critical
          service: system
          category: security
        annotations:
          summary: "Critical disk space on {{ $labels.instance }}"
          description: "Disk usage is {{ $value }}% on {{ $labels.mountpoint }} - possible disk filling attack"

      # Network Security Alerts
      - alert: HighNetworkIn
        expr: rate(node_network_receive_bytes_total[5m]) > 100 * 1024 * 1024  # 100MB/s
        for: 2m
        labels:
          severity: warning
          service: network
          category: security
        annotations:
          summary: "High network input on {{ $labels.instance }}"
          description: "Network input: {{ $value | humanize }}B/s on {{ $labels.device }}"

      - alert: SuspiciousNetworkActivity
        expr: rate(node_network_receive_bytes_total[1m]) > 500 * 1024 * 1024  # 500MB/s
        for: 30s
        labels:
          severity: critical
          service: network
          category: security
        annotations:
          summary: "Suspicious network activity on {{ $labels.instance }}"
          description: "Extremely high network input: {{ $value | humanize }}B/s - possible DDoS attack"

      # Docker Security Alerts
      - alert: ContainerDown
        expr: up{job=~"chitlaq.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: docker
          category: security
        annotations:
          summary: "ChitLaq container down: {{ $labels.job }}"
          description: "Container {{ $labels.job }} on {{ $labels.instance }} is down"

      - alert: ContainerHighCPU
        expr: rate(container_cpu_usage_seconds_total{name=~"chitlaq.*"}[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: docker
          category: security
        annotations:
          summary: "High CPU usage in container {{ $labels.name }}"
          description: "Container CPU usage: {{ $value }}%"

      - alert: ContainerHighMemory
        expr: (container_memory_usage_bytes{name=~"chitlaq.*"} / container_spec_memory_limit_bytes{name=~"chitlaq.*"}) * 100 > 90
        for: 5m
        labels:
          severity: warning
          service: docker
          category: security
        annotations:
          summary: "High memory usage in container {{ $labels.name }}"
          description: "Container memory usage: {{ $value }}%"

      # Application Security Alerts
      - alert: SuspiciousAPIActivity
        expr: rate(nginx_http_requests_total{uri=~"/api/.*",status=~"4.."}[5m]) > 20
        for: 2m
        labels:
          severity: warning
          service: api
          category: security
        annotations:
          summary: "Suspicious API activity detected"
          description: "High rate of 4xx errors on API endpoints: {{ $value }} per second"

      - alert: SQLInjectionAttempt
        expr: increase(nginx_http_requests_total{uri=~".*union.*select.*"}[1m]) > 0
        for: 0s
        labels:
          severity: critical
          service: security
          category: security
        annotations:
          summary: "Possible SQL injection attempt detected"
          description: "SQL injection pattern detected in request URI"

      - alert: XSSAttempt
        expr: increase(nginx_http_requests_total{uri=~".*script.*alert.*"}[1m]) > 0
        for: 0s
        labels:
          severity: critical
          service: security
          category: security
        annotations:
          summary: "Possible XSS attempt detected"
          description: "XSS pattern detected in request URI"

      # Fail2ban Integration Alerts
      - alert: Fail2banHighBanRate
        expr: increase(fail2ban_banned_total[5m]) > 10
        for: 1m
        labels:
          severity: warning
          service: fail2ban
          category: security
        annotations:
          summary: "High fail2ban ban rate"
          description: "{{ $value }} IPs banned by fail2ban in the last 5 minutes"

      - alert: Fail2banMassiveBanning
        expr: increase(fail2ban_banned_total[1m]) > 50
        for: 30s
        labels:
          severity: critical
          service: fail2ban
          category: security
        annotations:
          summary: "Massive fail2ban banning activity"
          description: "{{ $value }} IPs banned in 1 minute - possible coordinated attack"

      # SSL/TLS Security Alerts
      - alert: SSLCertificateExpiring
        expr: (ssl_certificate_expiry_seconds - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          service: ssl
          category: security
        annotations:
          summary: "SSL certificate expiring soon"
          description: "SSL certificate for {{ $labels.domain }} expires in {{ $value }} days"

      - alert: SSLCertificateExpiringSoon
        expr: (ssl_certificate_expiry_seconds - time()) / 86400 < 7
        for: 1h
        labels:
          severity: critical
          service: ssl
          category: security
        annotations:
          summary: "SSL certificate expiring very soon"
          description: "SSL certificate for {{ $labels.domain }} expires in {{ $value }} days"

      # Log Analysis Alerts
      - alert: SecurityLogErrors
        expr: increase(promtail_read_errors_total[5m]) > 5
        for: 2m
        labels:
          severity: warning
          service: logging
          category: security
        annotations:
          summary: "Security log reading errors"
          description: "{{ $value }} log reading errors in the last 5 minutes"

      - alert: AuditLogMissing
        expr: time() - audit_log_last_entry_timestamp > 600  # 10 minutes
        for: 5m
        labels:
          severity: critical
          service: audit
          category: security
        annotations:
          summary: "Audit log entries missing"
          description: "No audit log entries for 10+ minutes - possible tampering"

      # Backup Security Alerts
      - alert: BackupFailed
        expr: backup_last_success_timestamp + 86400 < time()  # 24 hours
        for: 1h
        labels:
          severity: critical
          service: backup
          category: security
        annotations:
          summary: "Backup failed"
          description: "No successful backup in the last 24 hours"

      - alert: BackupIntegrityFailed
        expr: backup_integrity_check_failed > 0
        for: 5m
        labels:
          severity: critical
          service: backup
          category: security
        annotations:
          summary: "Backup integrity check failed"
          description: "Backup integrity verification failed - possible data corruption"

      # Intrusion Detection Alerts
      - alert: SuspiciousLoginPattern
        expr: increase(auth_failed_logins_total[10m]) > 50
        for: 1m
        labels:
          severity: warning
          service: auth
          category: security
        annotations:
          summary: "Suspicious login pattern detected"
          description: "{{ $value }} failed logins in 10 minutes from {{ $labels.source_ip }}"

      - alert: BruteForceAttack
        expr: increase(auth_failed_logins_total{source_ip!~"127.0.0.1|::1"}[2m]) > 20
        for: 30s
        labels:
          severity: critical
          service: auth
          category: security
        annotations:
          summary: "Possible brute force attack"
          description: "{{ $value }} failed logins in 2 minutes from {{ $labels.source_ip }}"

      # File Integrity Alerts
      - alert: CriticalFileModified
        expr: increase(file_integrity_violations_total{file=~"/etc/(passwd|shadow|sudoers|ssh/sshd_config)"}[1m]) > 0
        for: 0s
        labels:
          severity: critical
          service: integrity
          category: security
        annotations:
          summary: "Critical system file modified"
          description: "Critical file {{ $labels.file }} has been modified"

      - alert: ConfigurationFileModified
        expr: increase(file_integrity_violations_total{file=~"/etc/nginx/.*|/opt/chitlaq/.*"}[1m]) > 0
        for: 0s
        labels:
          severity: warning
          service: integrity
          category: security
        annotations:
          summary: "Configuration file modified"
          description: "Configuration file {{ $labels.file }} has been modified"

  # Security Incident Response Rules
  - name: chitlaq.security.incident
    interval: 15s
    rules:
      # Critical Security Incident
      - alert: SecurityIncidentDetected
        expr: |
          (
            ALERTS{alertname=~"SuspiciousAuthActivity|MassiveRateLimiting|SuspiciousNetworkActivity|BruteForceAttack",severity="critical"}
          ) > 0
        for: 0s
        labels:
          severity: critical
          service: security
          category: incident
        annotations:
          summary: "Critical security incident detected"
          description: "Multiple critical security alerts active - immediate response required"

      # Security Incident Escalation
      - alert: SecurityIncidentEscalation
        expr: |
          count(
            ALERTS{severity="critical",category="security"}
          ) >= 3
        for: 1m
        labels:
          severity: critical
          service: security
          category: incident
        annotations:
          summary: "Security incident escalation"
          description: "{{ $value }} critical security alerts active - escalating to security team"
