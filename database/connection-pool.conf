# ChitLaq M1 MVP - PostgreSQL Connection Pool Configuration
# PgBouncer configuration for production optimized connection pooling
# Generated by PROMPT 1.3 - Database Schema & Migrations

# ===============================
# PGBOUNCER CONFIGURATION
# ===============================

[databases]
# Main application database
chitlaq_main = host=localhost port=5432 dbname=chitlaq_main user=chitlaq_app password=your_app_password pool_size=25 max_db_connections=30

# Read-only replica for analytics and reporting
chitlaq_readonly = host=localhost port=5433 dbname=chitlaq_main user=chitlaq_readonly password=your_readonly_password pool_size=15 max_db_connections=20

# Auth database (if separate)
chitlaq_auth = host=localhost port=5432 dbname=chitlaq_auth user=chitlaq_auth password=your_auth_password pool_size=10 max_db_connections=15

[pgbouncer]
# ===============================
# POOL SETTINGS
# ===============================

# Pool mode (session, transaction, statement)
# session = client stays connected to server for the session
# transaction = server is released back to pool after transaction finishes
# statement = server is released back to pool after statement finishes
pool_mode = transaction

# Listen on all interfaces (change to specific IP in production)
listen_addr = 0.0.0.0
listen_port = 6432

# Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Admin interface
admin_users = pgbouncer_admin
stats_users = pgbouncer_stats

# ===============================
# CONNECTION LIMITS
# ===============================

# Maximum number of client connections
max_client_conn = 200

# Default pool size (per database/user combination)
default_pool_size = 20

# Minimum pool size (connections kept alive)
min_pool_size = 5

# Reserve pool - connections for new pools
reserve_pool_size = 5

# Maximum time a connection can stay unused in seconds
reserve_pool_timeout = 3600

# ===============================
# CONNECTION TIMEOUTS
# ===============================

# How long to wait when connecting to backend
server_connect_timeout = 15

# How long to wait for login
server_login_retry = 15

# Queries longer than this are cancelled
query_timeout = 30

# Queries longer than this are logged
query_wait_timeout = 120

# Client connections idling longer than this are closed
client_idle_timeout = 0

# Server connections idling longer than this are closed  
server_idle_timeout = 600

# Server connections older than this are closed
server_lifetime = 3600

# How long to wait for server response to RESET/ROLLBACK
server_reset_query_always = 0

# ===============================
# LOGGING & MONITORING
# ===============================

# Log file location
logfile = /var/log/pgbouncer/pgbouncer.log

# Syslog settings
syslog = 1
syslog_facility = daemon
syslog_ident = pgbouncer

# Log level: 0=none, 1=urgent, 2=normal, 3=verbose, 4=debug
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

# Stats period in seconds
stats_period = 60

# ===============================
# PERFORMANCE TUNING
# ===============================

# Listen backlog
listen_backlog = 128

# TCP socket options
tcp_defer_accept = 45
tcp_socket_buffer = 0
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 600
tcp_keepintvl = 30

# Disable DNS lookups for better performance
disable_pqexec = 0

# Buffer sizes
pkt_buf = 4096
max_packet_size = 2147483647

# ===============================
# SECURITY SETTINGS
# ===============================

# Ignore startup parameters from client
ignore_startup_parameters = extra_float_digits

# Only allow SSL connections in production
;server_tls_sslmode = require
;server_tls_ca_file = /etc/ssl/certs/ca-bundle.crt
;server_tls_cert_file = /etc/ssl/certs/pgbouncer.crt
;server_tls_key_file = /etc/ssl/private/pgbouncer.key

# Client SSL (uncomment for production)
;client_tls_sslmode = require
;client_tls_ca_file = /etc/ssl/certs/ca-bundle.crt
;client_tls_cert_file = /etc/ssl/certs/pgbouncer.crt
;client_tls_key_file = /etc/ssl/private/pgbouncer.key

# ===============================
# APPLICATION-SPECIFIC POOLS
# ===============================

# Different pool configurations for different app components
[chitlaq_realtime]
host = localhost
port = 5432
dbname = chitlaq_main
user = chitlaq_realtime
password = your_realtime_password
pool_size = 15
max_db_connections = 20
# Realtime connections tend to be longer-lived
pool_mode = session

[chitlaq_api]
host = localhost
port = 5432
dbname = chitlaq_main
user = chitlaq_api
password = your_api_password
pool_size = 30
max_db_connections = 40
# API connections are typically short
pool_mode = transaction

[chitlaq_background]
host = localhost
port = 5432
dbname = chitlaq_main
user = chitlaq_background
password = your_background_password
pool_size = 5
max_db_connections = 10
# Background jobs can be longer running
pool_mode = session

# ===============================
# READ REPLICA CONFIGURATION
# ===============================

[chitlaq_analytics]
host = localhost
port = 5433  # Read replica port
dbname = chitlaq_main
user = chitlaq_analytics
password = your_analytics_password
pool_size = 10
max_db_connections = 15
# Analytics queries can be complex and long-running
pool_mode = session
query_timeout = 300

[chitlaq_feed]
host = localhost
port = 5433  # Read replica for feed generation
dbname = chitlaq_main
user = chitlaq_feed
password = your_feed_password
pool_size = 20
max_db_connections = 25
pool_mode = transaction

# ===============================
# DEVELOPMENT CONFIGURATION
# ===============================

# Separate section for development
[chitlaq_dev]
host = localhost
port = 5432
dbname = chitlaq_dev
user = chitlaq_dev
password = dev_password
pool_size = 5
max_db_connections = 10
pool_mode = session
